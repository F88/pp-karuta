import{P as he,c as ge}from"./api-vendor-BiSSTL-X.js";import{W as ie,w as me}from"./vendor-CsvY6vLv.js";const X=["debug","info","warn","error","silent"],B=e=>typeof console<"u"&&typeof console[e]=="function"?console[e].bind(console):void 0;class A{level;hasConsole;constructor(t="info"){this.level=t,this.hasConsole=typeof console<"u",this.error=this.error.bind(this),this.warn=this.warn.bind(this),this.info=this.info.bind(this),this.debug=this.debug.bind(this)}error(t,s){this.log("error",t,s,B("error"))}warn(t,s){this.log("warn",t,s,B("warn"))}info(t,s){this.log("info",t,s,B("info"))}debug(t,s){this.log("debug",t,s,B("debug"))}log(t,s,n,r){if(!this.shouldLog(t)||!this.hasConsole||!r)return;const a=`${`[${t.toUpperCase()}]`} ${s}`;n===void 0?r(a):r(a,n)}shouldLog(t){return this.level==="silent"?!1:X.indexOf(t)>=X.indexOf(this.level)}}const pe=540*60*1e3;function ye(e){if(typeof e!="string"||e.length===0)return;const t=e.match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})\.(\d+)$/);if(!t)return;const[,s,n,r,o,a,i,c]=t,l=Number(s),u=Number(n),d=Number(r),h=Number(o),p=Number(a),m=Number(i),y=c.padEnd(3,"0").slice(0,3),T=Number(y);if([l,u,d,h,p,m,T].some(L=>Number.isNaN(L)))return;const P=Date.UTC(l,u-1,d,h,p,m,T)-pe;return Number.isFinite(P)?new Date(P).toISOString():void 0}function Ee(e){if(typeof e!="string"||e.length===0||!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?(\.\d+)?([Zz]|[+-]\d{2}:\d{2})$/.test(e))return;const s=new Date(e);if(!Number.isNaN(s.getTime()))return s.toISOString()}function J(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}const Q=100;function W(e,t,s=new WeakSet,n=0){if(n>Q)return console.warn(`deepMerge: Maximum depth (${Q}) exceeded`),e;const r={...e};for(const o of Object.keys(t)){if(o==="__proto__"||o==="constructor"||o==="prototype")continue;const a=t[o],i=e[o];if(J(a)){if(s.has(a))continue;s.add(a);const c=J(i)?i:{};r[o]=W(c,a,s,n+1),s.delete(a)}else a!==void 0&&(Array.isArray(a)?r[o]=[...a]:r[o]=a)}return r}const ae=["token","auth","password","secret","credential"],Se=new RegExp(ae.join("|"),"i"),Te=new Set(["__proto__","constructor","prototype"]),we=100,ee=new Map,te=100;function Ae(e){for(const t of e){if(typeof t!="string")throw new TypeError(`Invalid sensitive key: expected string, got ${typeof t}`);if(t.length===0)throw new TypeError("Sensitive key cannot be empty");if(t.length>te)throw new TypeError(`Sensitive key too long (max ${te} characters): ${t.slice(0,20)}...`);if(/[*+{].*[*+{]/.test(t))throw new TypeError(`Potentially dangerous regex pattern detected: ${t}`)}}function Re(e=[]){if(e.length===0)return Se;Ae(e);const s=[...ae,...e].sort().join("|");let n=ee.get(s);return n||(n=new RegExp(s,"i"),ee.set(s,n)),n}function g(e,t={}){const s=new WeakSet,n=Re(t.additionalSensitiveKeys);function r(i){return n.test(i)}const o=new Set(["name","message","stack"]);function a(i,c=0){if(c>=we)return"[Max Depth Exceeded]";if(i===null||typeof i!="object")return typeof i=="function"?`[Function: ${i.name||"anonymous"}]`:typeof i=="symbol"?i.toString():typeof i=="bigint"?`${i.toString()}n`:i;if(s.has(i))return"[Circular]";if(s.add(i),i instanceof Error){const d={name:i.name,message:i.message,stack:i.stack};for(const h of Object.getOwnPropertyNames(i))if(!o.has(h))if(r(h))d[h]="***";else{const p=i;d[h]=a(p[h],c+1)}return d}if(i instanceof Map)return{__type:"Map",entries:Array.from(i.entries()).map(([d,h])=>{const p=typeof d=="string"&&r(d),m=p?"***":a(d,c+1),y=p?"***":a(h,c+1);return[m,y]})};if(i instanceof Set)return{__type:"Set",values:Array.from(i).map(d=>a(d,c+1))};if(Array.isArray(i))return i.map(d=>a(d,c+1));const l={},u=i;for(const d of Object.keys(u))Te.has(d)||(r(d)?l[d]="***":l[d]=a(u[d],c+1));return l}return a(e)}const ce="1.0.0";class de extends Error{timeoutMs;constructor(t,s){super(s??`Upstream request timed out after ${t}ms`),Object.setPrototypeOf(this,new.target.prototype),this.name="PromidasTimeoutError",this.timeoutMs=t}}function Ne(e){return e instanceof DOMException&&e.name==="AbortError"}function Ie(e){const{timeoutMs:t,baseFetch:s}=e;return async(n,r)=>{const o=s??globalThis.fetch,a=new AbortController,i=new de(t),c=()=>{a.abort(r?.signal?.reason)};r?.signal?.aborted?c():r?.signal&&r.signal.addEventListener("abort",c,{once:!0});const l=setTimeout(()=>{a.abort(i)},t);try{return await o(n,{...r,signal:a.signal})}catch(u){throw u===i?u:Ne(u)&&a.signal.reason===i?i:u}finally{clearTimeout(l),r?.signal&&r.signal.removeEventListener("abort",c)}}}function b(e){if("level"in e&&typeof e.level=="string"){const t=e.level;return t==="debug"||t==="info"}return!0}function _e(e){try{const s=new URL(e).searchParams.get("limit");if(!s)return{estimatedSize:0,itemCount:0};const n=parseInt(s,10);return isNaN(n)||n<=0?{estimatedSize:0,itemCount:0}:{estimatedSize:n*2670,itemCount:n}}catch{return{estimatedSize:0,itemCount:0}}}function be(e){const{logger:t,enableProgressLog:s,baseFetch:n,onProgressEvent:r}=e;return async(o,a)=>{let i=-1,c=0,l=0,u=!1,d=0;const h=Date.now();s&&b(t)&&t.info("Request starting..."),r?.({type:"request-start"});const m=await(n??globalThis.fetch)(o,a),y=Date.now(),T=y-h,P=m.headers.get("Content-Length");let f=P?parseInt(P,10):0;isNaN(f)&&(f=0);const L=_e(o.toString());if(d=L.itemCount,f===0&&(f=L.estimatedSize,u=f>0),s&&f>0&&b(t)){const N=u?" (estimated)":"";t.info(`Response received (${T}ms) - ${f} bytes${N}, limit=${d}`)}if(r?.({type:"response-received",prepareTimeMs:T,estimatedTotal:f,limit:d}),!m.body){const S=Date.now()-h;if(s&&b(t)){const w=u?`Download complete: 0 bytes received (estimated ${f} bytes) in 0ms (total: ${S}ms)`:`Download complete: 0 / ${f} bytes received in 0ms (total: ${S}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${w}
`):t.info(w)}return r?.({type:"complete",received:0,estimatedTotal:f,downloadTimeMs:0,totalTimeMs:S}),m}const ue=m.body.getReader();let E=0;const fe=new ReadableStream({async start(N){try{for(;;){const{done:S,value:w}=await ue.read();if(S){const $=Date.now(),z=$-h,_=$-y;if(s&&b(t)){const Z=u?`Download complete: ${E} bytes received (estimated ${f} bytes) in ${_}ms (total: ${z}ms)`:`Download complete: ${E} / ${f} bytes received in ${_}ms (total: ${z}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${Z}
`):t.info(Z)}r?.({type:"complete",received:E,estimatedTotal:f,downloadTimeMs:_,totalTimeMs:z}),N.close();break}E+=w.length;const I=f>0?E/f*100:0,M=Date.now(),F=M-l,v=l===0;if(v||F>=500){if(s&&b(t)){const $=E-c,z=u&&v?" (estimated)":"",_=`Download progress: ${I.toFixed(1)}%${z} (${E} / ${f} bytes, +${$})`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${_}`):t.info(_)}r?.({type:"download-progress",received:E,total:f,percentage:I}),i=I,c=E,l=M}N.enqueue(w)}}catch(S){const w=Date.now(),I=w-h,M=w-y,F=S instanceof Error?S.message:String(S);if(s&&b(t)){const v=`Download error: ${F} (${I}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${v}
`):t.error(v)}r?.({type:"error",error:F,received:E,estimatedTotal:f,downloadTimeMs:M,totalTimeMs:I}),N.error(S)}}});return new Response(fe,{status:m.status,statusText:m.statusText,headers:m.headers})}}function Ce(e){const{logger:t,enableProgressLog:s,baseFetch:n,onProgressEvent:r}=e;return s||r!==void 0?be({logger:t,enableProgressLog:s,...n!==void 0&&{baseFetch:n},...r!==void 0&&{onProgressEvent:r}}):n}function De(e){return e.map(t=>t.trim()).filter(t=>t!=="").map(t=>t.toLowerCase())}function Oe(e){const{baseFetch:t}=e,s=De(e.headerNames);return async(n,r)=>{if(s.length===0)return t(n,r);if(typeof Request<"u"&&n instanceof Request){const o=new Headers(n.headers);r?.headers!==void 0&&new Headers(r.headers).forEach((c,l)=>{o.set(l,c)});for(const i of s)o.delete(i);const a=new Request(n,{headers:o});return r!==void 0?t(a,{...r,headers:o}):t(a)}if(r?.headers!==void 0){const o=new Headers(r.headers);for(const a of s)o.delete(a);return t(n,{...r,headers:o})}return t(n,r)}}function Pe(e){const{logger:t,enableProgressLog:s,progressCallback:n,timeoutMs:r,providedFetch:o,stripHeaders:a}=e,i=typeof r=="number"?Ie({timeoutMs:r,baseFetch:o}):o,c=Array.isArray(a)&&a.length>0,l=c?i??(typeof globalThis.fetch=="function"?globalThis.fetch:void 0):void 0,u=c?l!==void 0?Oe({baseFetch:l,headerNames:a}):void 0:i;return Ce({logger:t,enableProgressLog:s,...u!==void 0&&{baseFetch:u},...n!==void 0&&{onProgressEvent:n}})}const ve={ABORT:"AbortError"},V={ABORTED:"Upstream request aborted",TIMEOUT:"Upstream request timed out",UNKNOWN:"Failed to fetch prototypes"},ze="NETWORK_ERROR",ke=new Set(["Failed to fetch","fetch failed","Load failed","NetworkError when attempting to fetch resource."]),xe={400:"CLIENT_BAD_REQUEST",401:"CLIENT_UNAUTHORIZED",403:"CLIENT_FORBIDDEN",404:"CLIENT_NOT_FOUND",405:"CLIENT_METHOD_NOT_ALLOWED",408:"CLIENT_TIMEOUT",429:"CLIENT_RATE_LIMITED",500:"SERVER_INTERNAL_ERROR",502:"SERVER_BAD_GATEWAY",503:"SERVER_SERVICE_UNAVAILABLE",504:"SERVER_GATEWAY_TIMEOUT"};function Le(e){return e instanceof DOMException&&e.name===ve.ABORT}function Me(e){return e!==null&&typeof e=="object"}function C(e,t,s){const n={ok:!1,origin:"fetcher",error:e,details:t};return s!==void 0&&(n.status=s),n}function Fe(e){if(e===void 0)return"UNKNOWN";const t=xe[e];return t!==void 0?t:e>=500&&e<600?"SERVER_ERROR":e>=400&&e<500?"CLIENT_ERROR":"UNKNOWN"}function D(e,t,s){return{...e,kind:t,code:s}}function $e(e){const t=C(e.message,{req:{url:e.req.url,method:e.req.method},res:{statusText:e.statusText}},e.status);return D(t,"http",Fe(e.status))}function Be(e){if(e instanceof de){const o=C(V.TIMEOUT,{res:{code:"TIMEOUT"}});return D(o,"timeout","TIMEOUT")}if(Le(e)){const o=C(V.ABORTED,{res:{code:"ABORTED"}});return D(o,"abort","ABORTED")}const t=e instanceof Error?e.message:V.UNKNOWN,s={};if(Me(e)){const o=e,a=o.code??o.cause?.code;a!==void 0&&(s.res??={},s.res.code=a)}const n=e instanceof TypeError&&ke.has(t);if(s.res?.code===void 0&&n){s.res??={},s.res.code=ze;const o=C(t,s);return D(o,"cors","CORS_BLOCKED")}if(s.res?.code!==void 0){const o=C(t,s),a=s.res.code;return D(o,"network",a)}const r=C(t,s);return D(r,"unknown","UNKNOWN")}function Ue(e){return e instanceof he?$e(e):Be(e)}function We(e){const{logger:t,original:s,normalized:n,index:r}=e,o={prototypeId:s.id,index:r};s.createDate&&n.createDate===s.createDate&&!n.createDate.endsWith("Z")&&t.warn("Failed to parse and normalize createDate",{...o,originalValue:s.createDate}),s.updateDate&&n.updateDate===s.updateDate&&!n.updateDate.endsWith("Z")&&t.warn("Failed to parse and normalize updateDate",{...o,originalValue:s.updateDate}),s.releaseDate&&n.releaseDate===s.releaseDate&&!n.releaseDate.endsWith("Z")&&t.warn("Failed to parse and normalize releaseDate",{...o,originalValue:s.releaseDate})}function q(e){if(e===null)return null;if(e===void 0)return;const t=ye(e);if(t!==void 0)return t;const s=Ee(e);return s!==void 0?s:e}const k=e=>typeof e!="string"||e.length===0?[]:e.split("|").map(t=>t.trim()).filter(t=>t.length>0);function je(e){const t=q(e.createDate)??e.createDate,s=q(e.updateDate)??e.updateDate,n=q(e.releaseDate)??void 0;return{id:e.id,createDate:t,updateDate:s,releaseDate:n,createId:e.createId,updateId:e.updateId,releaseFlg:e.releaseFlg??2,status:e.status,prototypeNm:e.prototypeNm,summary:e.summary??"",freeComment:e.freeComment??"",systemDescription:e.systemDescription??"",users:k(e.users),teamNm:e.teamNm??"",tags:k(e.tags),materials:k(e.materials),events:k(e.events),awards:k(e.awards),officialLink:e.officialLink,videoUrl:e.videoUrl,mainUrl:e.mainUrl,relatedLink:e.relatedLink,relatedLink2:e.relatedLink2,relatedLink3:e.relatedLink3,relatedLink4:e.relatedLink4,relatedLink5:e.relatedLink5,viewCount:e.viewCount,goodCount:e.goodCount,commentCount:e.commentCount,uuid:e.uuid,nid:e.nid,revision:e.revision??0,licenseType:e.licenseType??1,thanksFlg:e.thanksFlg??0,slideMode:e.slideMode}}class Ke{#e;#s;#t;constructor(t){const{protoPediaApiClientOptions:s={},logger:n,logLevel:r,progressLog:o=!0,progressCallback:a}=t??{},{timeoutMs:i,fetch:c,...l}=s;if(n)this.#s=n,this.#t=r??"info",r!==void 0&&"level"in n&&(n.level=r);else{const T=r??"info";this.#s=new A(T),this.#t=T}this.#s.info("ProtopediaApiCustomClient constructor called",g(t));const u=typeof globalThis.window<"u",d=typeof globalThis.document<"u",h=u&&d,p=l.userAgent??`ProtopediaApiCustomClient/${ce} (promidas)`,m=h?["x-client-user-agent"]:void 0,y=Pe({logger:this.#s,enableProgressLog:o,progressCallback:a,timeoutMs:i,providedFetch:c,stripHeaders:m});this.#e=ge({...l,userAgent:p,...y!==void 0&&{fetch:y}})}async#r(t){try{const s=await this.#e.listPrototypes(t);let n=[];return Array.isArray(s.results)?n=s.results.map((r,o)=>{const a=r,i=je(a);return We({logger:this.#s,original:a,normalized:i,index:o}),i}):this.#s.warn('Upstream API response "results" is not an array. Returning empty data.',{upstreamResults:s.results,params:t}),this.#s.debug(`Successfully fetched ${n.length} prototypes.`,{params:t}),{ok:!0,data:n}}catch(s){const n=Ue(s);if(!n.ok){const r=g(n);n.status===void 0||n.status>=500?this.#s.error(n.error,r):this.#s.warn(n.error,r)}return n}}async fetchPrototypes(t){return this.#r(t)}async listPrototypes(t){return this.#e.listPrototypes(t)}}class x extends Error{dataState;constructor(t,s="UNKNOWN",n){super(t,n),this.name="StoreError",this.dataState=s}}class le extends x{constructor(t){super(t,"UNKNOWN"),this.name="ConfigurationError"}}class K extends x{dataSizeBytes;maxDataSizeBytes;constructor(t,s,n){super(`Snapshot data size (${s} bytes) exceeds maximum limit (${n} bytes)`,t),this.name="DataSizeExceededError",this.dataSizeBytes=s,this.maxDataSizeBytes=n}}class O extends x{constructor(t="UNKNOWN",s){super("Failed to estimate data size for snapshot",t,{cause:s}),this.name="SizeEstimationError"}}const He=1800*1e3,Ve=10*1024*1024,j=30*1024*1024;class qe{logger;logLevel;ttlMs;maxDataSizeBytes;prototypeIdIndex=new Map;prototypes=[];cachedAt=null;dataSizeBytes=0;refreshPromise=null;constructor({ttlMs:t=He,maxDataSizeBytes:s=Ve,logger:n,logLevel:r}={}){if(this.ttlMs=t,this.maxDataSizeBytes=s,n)this.logger=n,this.logLevel=r??"info",r!==void 0&&"level"in n&&(n.level=r);else{const o=r??"info";this.logger=new A(o),this.logLevel=o}if(this.logger.info("PrototypeInMemoryStore constructor called",{ttlMs:t,maxDataSizeBytes:s,logger:n?"custom":void 0,logLevel:r}),s>j){const o=(j/1048576).toFixed(0);throw new le(`PrototypeInMemoryStore maxDataSizeBytes must be <= ${j} bytes (${o} MiB) to prevent oversized data`)}}getConfig(){return{ttlMs:this.ttlMs,maxDataSizeBytes:this.maxDataSizeBytes,logLevel:this.logLevel}}get size(){return this.prototypeIdIndex.size}getCachedAt(){return this.cachedAt}getElapsedTime(){return this.cachedAt?Date.now()-this.cachedAt.getTime():0}getRemainingTtl(){if(!this.cachedAt)return 0;const t=this.getElapsedTime(),s=this.ttlMs-t;return Math.max(0,s)}isExpired(){return this.cachedAt?this.getElapsedTime()>this.ttlMs:!0}isRefreshInFlight(){return this.refreshPromise!==null}getStats(){return{size:this.prototypeIdIndex.size,cachedAt:this.cachedAt,isExpired:this.isExpired(),remainingTtlMs:this.getRemainingTtl(),dataSizeBytes:this.dataSizeBytes,refreshInFlight:this.isRefreshInFlight()}}estimateSize(t){try{if(t.length===0)return 2;let s=2+(t.length-1);if(typeof Buffer<"u")for(const n of t)s+=Buffer.byteLength(JSON.stringify(n),"utf8");else if(typeof TextEncoder<"u"){const n=new TextEncoder;for(const r of t)s+=n.encode(JSON.stringify(r)).length}else return this.logger.warn("Neither Buffer nor TextEncoder found for size estimation. Returning 0.",{}),0;return s}catch(s){throw this.logger.error("Failed to estimate payload size",{error:g(s)}),new O("UNKNOWN",s instanceof Error?s:void 0)}}runExclusive(t){return this.refreshPromise?this.refreshPromise:(this.refreshPromise=(async()=>{try{await t()}catch(s){throw this.logger.error("PrototypeInMemoryStore refresh task failed",{error:g(s)}),s}finally{this.refreshPromise=null}})(),this.refreshPromise)}clear(){const t=this.prototypeIdIndex.size;this.prototypeIdIndex.clear(),this.prototypes=[],this.cachedAt=null,this.dataSizeBytes=0,this.logger.info("PrototypeInMemoryStore cleared",{previousSize:t})}setAll(t){const s=new Map(t.map(o=>[o.id,o]));s.size!==t.length&&this.logger.warn("Duplicate prototype IDs detected in snapshot",{inputCount:t.length,storedCount:s.size});const n=Array.from(s.values()),r=(()=>{try{return this.estimateSize(n)}catch(o){throw o instanceof O?new O("UNCHANGED",o.cause):o}})();if(r>this.maxDataSizeBytes)throw this.logger.warn("Snapshot rejected: data exceeds maximum size",{dataSizeBytes:r,maxDataSizeBytes:this.maxDataSizeBytes,inputCount:t.length,uniqueCount:s.size}),new K("UNCHANGED",r,this.maxDataSizeBytes);return this.prototypeIdIndex=s,this.prototypes=n,this.cachedAt=new Date,this.dataSizeBytes=r,this.logger.info("PrototypeInMemoryStore snapshot updated",{count:this.prototypeIdIndex.size,dataSizeBytes:r}),{dataSizeBytes:r}}getAll(){return this.prototypes}getSnapshot(){return{data:this.getAll(),cachedAt:this.cachedAt,isExpired:this.isExpired()}}getByPrototypeId(t){return this.prototypeIdIndex.get(t)??null}getPrototypeIds(){return Array.from(this.prototypeIdIndex.keys())}}class se extends Error{field;constructor(t,s,n){super(t,n),this.name="ValidationError",this.field=s}}const Ge=ie().int().positive(),Ye=ie().int(),U=(e,t,s,...n)=>{if(e)try{e.emit(s,...n)}catch(r){t.error("Repository event emission failed",{eventName:s,error:g(r),args:g(n)})}};function Ze(e){return e.ok?e:{ok:!1,origin:"fetcher",kind:e.kind,code:e.code,message:e.error,...e.status!==void 0&&{status:e.status},details:e.details}}const G={offset:0,limit:10},Xe=.5;class Je{events;#e;#s;#t;#r;#o={...G};#n=null;constructor({store:t,apiClient:s,repositoryConfig:n={}}){const{logger:r,logLevel:o,enableEvents:a}=n;if(r)this.#e=r,this.#s=o??"info",o!==void 0&&"level"in r&&(r.level=o);else{const i=o??"info";this.#e=new A(i),this.#s=i}a===!0&&(this.events=new me.EventEmitter,this.events.setMaxListeners(0)),this.#e.info("ProtopediaInMemoryRepository constructor called",{repositoryConfig:g(n),storeConfig:t.getConfig(),eventsEnabled:a===!0}),this.#t=t,this.#r=s}async fetchAndNormalize(t){const s={...G,...t};try{const n=await this.#r.fetchPrototypes(s);return n.ok&&this.#e.debug("Fetch operation completed",{count:n.data.length,params:s}),n}catch(n){return this.#e.error("Unexpected exception from API client",{error:g(n),params:s}),{ok:!1,origin:"fetcher",kind:"unknown",code:"UNKNOWN",error:n instanceof Error?n.message:String(n),details:{req:{method:"GET"}}}}}storeSnapshot(t){try{this.#t.setAll(t);const s=this.#t.getStats();return this.#e.debug("Store operation completed",{size:s.size,dataSizeBytes:s.dataSizeBytes}),{ok:!0,stats:s}}catch(s){return s instanceof K?(this.#e.warn("Snapshot storage failed: data size exceeded",{dataSizeBytes:s.dataSizeBytes,maxDataSizeBytes:s.maxDataSizeBytes,dataState:s.dataState}),{ok:!1,origin:"store",kind:"storage_limit",code:"STORE_CAPACITY_EXCEEDED",message:`Data size ${s.dataSizeBytes} bytes exceeds maximum ${s.maxDataSizeBytes} bytes`,dataState:s.dataState}):s instanceof O?(this.#e.error("Snapshot storage failed: size estimation error",{dataState:s.dataState,cause:g(s.cause)}),{ok:!1,origin:"store",kind:"serialization",code:"STORE_SERIALIZATION_FAILED",message:"Failed to estimate data size during serialization",dataState:s.dataState,cause:g(s.cause)}):(this.#e.error("Snapshot storage failed: unexpected error",{error:g(s)}),{ok:!1,origin:"store",kind:"unknown",code:"STORE_UNKNOWN",message:s instanceof Error?s.message:String(s),dataState:"UNKNOWN",cause:g(s)})}}getConfig(){return this.#t.getConfig()}getStats(){return this.#t.getStats()}async fetchAndStore(t,s){return this.#i(async()=>{const n=await this.fetchAndNormalize(t),r=Ze(n);if(!r.ok)return r;if(!("data"in r))throw new Error("Unexpected: success result missing data field");const o=this.storeSnapshot(r.data);return o.ok&&s&&(this.#o={...G,...t}),o})}async setupSnapshot(t){return U(this.events,this.#e,"snapshotStarted","setup"),this.fetchAndStore(t,!0)}async refreshSnapshot(){return U(this.events,this.#e,"snapshotStarted","refresh"),this.fetchAndStore(this.#o,!1)}async#i(t){if(this.#n)return this.#n;this.#n=t();try{const s=await this.#n;return s.ok?U(this.events,this.#e,"snapshotCompleted",s.stats):U(this.events,this.#e,"snapshotFailed",s),s}finally{this.#n=null}}async getPrototypeFromSnapshotByPrototypeId(t){const s=Ge.safeParse(t);if(!s.success)throw new se("Invalid prototype ID: must be a positive integer","prototypeId",{cause:s.error});return this.#t.getByPrototypeId(t)}async getRandomPrototypeFromSnapshot(){if(this.#t.size===0)return null;const t=this.#t.getAll(),s=Math.floor(Math.random()*t.length);return t[s]??null}async getRandomSampleFromSnapshot(t){const s=Ye.safeParse(t);if(!s.success)throw new se("Invalid sample size: must be an integer","size",{cause:s.error});if(t<=0||this.#t.size===0)return[];const n=this.#t.getAll(),r=Math.min(t,n.length);if(r>n.length*Xe){const i=[...n];for(let c=i.length-1;c>0;c--){const l=Math.floor(Math.random()*(c+1));[i[c],i[l]]=[i[l],i[c]]}return i.slice(0,r)}const o=[],a=new Set;for(;o.length<r;){const i=Math.floor(Math.random()*n.length);a.has(i)||(a.add(i),o.push(n[i]))}return o}async getPrototypeIdsFromSnapshot(){return this.#t.getPrototypeIds()}async getAllFromSnapshot(){return this.#t.getAll()}analyzePrototypesWithForLoop(t){if(t.length===0)return{min:null,max:null};let s=t[0].id,n=t[0].id;for(let r=1;r<t.length;r++){const o=t[r].id;o<s&&(s=o),o>n&&(n=o)}return{min:s,max:n}}async analyzePrototypes(){const t=this.#t.getAll();return this.analyzePrototypesWithForLoop(t)}dispose(){this.events?.removeAllListeners()}}class Qe{#e={};#s={};#t={};setStoreConfig(t){return this.#e=W(this.#e,t),this}setApiClientConfig(t){return this.#s=W(this.#s,t),this}setRepositoryConfig(t){return this.#t=W(this.#t,t),this}build(){const t={...this.#e,logger:this.#e.logger??new A(this.#e.logLevel??"info")},s={...this.#s,logger:this.#s.logger??new A(this.#s.logLevel??"info")},n=this.#t.logger??new A(this.#t.logLevel??"info"),r={...this.#t,logger:n},o=this.buildStore(t,n),a=this.buildApiClient(s,n);try{return new Je({store:o,apiClient:a,repositoryConfig:r})}catch(i){throw typeof n.error=="function"&&n.error("Failed to create ProtopediaInMemoryRepositoryImpl",g({error:i})),i}}buildStore(t,s){try{return new qe(t)}catch(n){if(typeof s.error=="function"){let r;n instanceof x?(r={error:n,dataState:n.dataState},n instanceof K?(r.dataSizeBytes=n.dataSizeBytes,r.maxDataSizeBytes=n.maxDataSizeBytes):n instanceof O&&(r.cause=n.cause)):r={error:n},s.error("Failed to create PrototypeInMemoryStore",g(r))}throw n}}buildApiClient(t,s){try{return new Ke(t)}catch(n){throw typeof s.error=="function"&&s.error("Failed to create ProtopediaApiCustomClient",g({error:n})),n}}}function pt(e){const t=new Qe,s=e.logLevel??"info",n=new A(s),r={ttlMs:1800*1e3,maxDataSizeBytes:j,logger:n};t.setStoreConfig(r);const o={protoPediaApiClientOptions:{token:e.protopediaApiToken,timeoutMs:90*1e3,userAgent:`PromidasForLocal/${ce}`,logger:n,logLevel:s},logger:n,progressLog:!0};t.setApiClientConfig(o);const a={logger:n};return t.setRepositoryConfig(a),t.build()}function Y(e){switch(e){case"UNCHANGED":return"既存のスナップショットは保持されます。";case"UNKNOWN":return"既存のスナップショットの状態は不明です。";default:return e}}function H(e,t,s){const n=[];for(const[r,o]of Object.entries(e))o!=null&&n.push(`${r}: ${o}`);return t&&!s.includes(t)&&n.push(`詳細: ${t}`),n.length===0?"":`

[参考情報]
${n.join(`
`)}`}function et(e){const t=["ストアの設定が無効です。","次を確認してください:","- maxDataSizeBytesが30 MiBを超えていないか","- 設定値の型や範囲が正しいか"].join(`
`),s=H({エラー種別:e.name},e.message,t);return`${t}${s}`}function tt(e){const t=["データサイズが制限を超えました。",Y(e.dataState),"次を試してください:","- limitパラメータを減らす","- ストアのmaxDataSizeBytesを増やす"].join(`
`),s=H({エラー種別:e.name,データサイズ:`${e.dataSizeBytes} バイト`,最大サイズ:`${e.maxDataSizeBytes} バイト`,dataState:e.dataState},e.message,t);return`${t}${s}`}function st(e){const t=["データサイズの推定に失敗しました。",Y(e.dataState),"次のような原因が考えられます:","- データに循環参照が含まれている","- JSONシリアライズできない型が含まれている"].join(`
`),s=H({エラー種別:e.name,dataState:e.dataState,原因:e.cause},e.message,t);return`${t}${s}`}function nt(e){const t=["ストアのエラーが発生しました。",Y(e.dataState)].join(`
`),s=H({エラー種別:e.name,dataState:e.dataState},e.message,t);return`${t}${s}`}function rt(e){return e.message?.includes("Missing PROTOPEDIA_API_V2_TOKEN")?"APIトークンが設定されていません":`不明なエラーが発生しました: ${e.message}`}function yt(e){return e?e instanceof K?tt(e):e instanceof O?st(e):e instanceof le?et(e):e instanceof x?nt(e):e instanceof Error?rt(e):"不明なエラーが発生しました。":"不明なエラーが発生しました。"}function ot(e){const t=r=>{const o=[],{method:a,url:i}=e.details.req??{};(a||i)&&o.push(`リクエスト: ${[a,i].filter(Boolean).join(" ")}`);const{statusText:c,code:l}=e.details.res??{};return(e.status||c)&&(e.status?o.push(`レスポンス: HTTP ${e.status}${c?` ${c}`:""}`):c&&o.push(`レスポンス: ${c}`)),l&&o.push(`レスポンスコード: ${l}`),o.push(`エラーコード: ${e.code}`),e.message&&r!==e.message&&o.push(`詳細: ${e.message}`),o},s=r=>{const o=t(r);return o.length===0?"":`

[参考情報]
${o.join(`
`)}`},n=r=>`${r}${s(r)}`;if(e.kind==="http"&&e.status)switch(e.status){case 400:return n("リクエストが不正です。パラメータを確認してください。");case 401:return n("APIトークンが無効です。設定を確認してください。");case 403:return n("アクセス権限がありません。");case 404:return n("データが見つかりません。");case 405:return n("許可されていないHTTPメソッドです。");case 408:return n("リクエストがタイムアウトしました。");case 429:return n("リクエスト数が制限を超えました。しばらく待ってから再試行してください。");case 500:return n("サーバーエラーが発生しました。");case 502:return n("ゲートウェイエラーが発生しました。");case 503:return n("サービスが一時的に利用できません。");case 504:return n("ゲートウェイタイムアウトが発生しました。");default:if(e.status>=400&&e.status<500){const r=`クライアントエラーが発生しました (HTTP ${e.status})。リクエスト内容を確認してください。`;return n(r)}if(e.status>=500&&e.status<600){const r=`サーバーエラーが発生しました (HTTP ${e.status})。しばらく待ってから再試行してください。`;return n(r)}{const r=`HTTPエラーが発生しました (HTTP ${e.status})。`;return n(r)}}switch(e.code){case"CLIENT_UNAUTHORIZED":return n("APIトークンが無効です。設定を確認してください。");case"CLIENT_FORBIDDEN":return n("アクセスが拒否されました。APIトークンの権限を確認してください。");case"CLIENT_NOT_FOUND":return n("リクエストしたリソースが見つかりませんでした。");case"CLIENT_RATE_LIMITED":return n("リクエスト制限に達しました。しばらく待ってから再試行してください。");case"CLIENT_BAD_REQUEST":return n("リクエストが不正です。パラメータを確認してください。");case"CLIENT_METHOD_NOT_ALLOWED":return n("許可されていないHTTPメソッドです。");case"CLIENT_TIMEOUT":return n("リクエストがタイムアウトしました。再試行してください。");case"CLIENT_ERROR":return n("クライアントエラーが発生しました。リクエスト内容を確認してください。");case"SERVER_INTERNAL_ERROR":case"SERVER_BAD_GATEWAY":case"SERVER_GATEWAY_TIMEOUT":case"SERVER_SERVICE_UNAVAILABLE":case"SERVER_ERROR":return n("サーバーエラーが発生しました。しばらく待ってから再試行してください。");case"NETWORK_ERROR":return n(["ネットワークエラーが発生しました。","次のような原因が考えられます:","- ネットワークがオフライン","- サーバーが一時的に利用できない","- ファイアウォールやプロキシの設定"].join(`
`));case"ECONNREFUSED":return n("サーバーに接続できませんでした。サーバーが起動しているか確認してください。");case"ENOTFOUND":return n("サーバーが見つかりませんでした。URLを確認してください。");case"ETIMEDOUT":case"TIMEOUT":return n("リクエストがタイムアウトしました。ネットワーク接続を確認してください。");case"ABORTED":return n("リクエストがキャンセルされました。");case"CORS_BLOCKED":return n(["APIサーバーとの通信がCORSポリシーによりブロックされました。","最も可能性が高い原因:","- APIトークンが未設定、または無効","注: ProtoPedia API は Access-Control-Allow-Origin を付与しないため、PROMIDASでは401(認証エラー)を正しく判定出来ません。"].join(`
`));case"UNKNOWN":return n(e.message);default:return e.code}}function it(e){const t=r=>{switch(r){case"UNCHANGED":return"既存のスナップショットは保持されます。";case"UNKNOWN":return"既存のスナップショットの状態は不明です。";default:return r}},s=r=>{const o=[];return o.push(`エラーコード: ${e.code}`),o.push(`分類: ${e.kind}`),o.push(`dataState: ${e.dataState}`),e.message&&r!==e.message&&o.push(`詳細: ${e.message}`),o.length===0?"":`

[参考情報]
${o.join(`
`)}`},n=r=>`${r}${s(r)}`;switch(e.code){case"STORE_CAPACITY_EXCEEDED":return n(["データサイズが制限を超えました。",t(e.dataState),"次を試してください:","- limitパラメータを減らす","- ストアのmaxDataSizeBytesを増やす(設定可能な場合)"].join(`
`));case"STORE_SERIALIZATION_FAILED":return n(["データのシリアライズに失敗しました。",t(e.dataState),"データ形式に問題がある可能性があります。"].join(`
`));case"STORE_UNKNOWN":return n(["ストレージエラーが発生しました。",t(e.dataState)].join(`
`));default:return e.code}}function at(e){return e.message}function Et(e){if(!e)return null;const t=ct(e);return{...e,localizedMessage:t}}function ct(e){if(!e)return"不明なエラーが発生しました。";const t=e.origin;switch(t){case"fetcher":return ot(e);case"store":return it(e);case"unknown":return at(e);default:return t}}const St=Object.freeze({PROTOPEDIA_API_V2_TOKEN:"PROTOPEDIA_API_V2_TOKEN"});class R extends Error{constructor(t="Required environment is not available"){super(t),this.name="EnvironmentUnavailableError"}}class ne{storage;key;constructor(t,s){this.storage=t,this.key=s}ensureStorageAvailable(){if(typeof this.storage>"u")throw new R("Web Storage API is not available")}async has(){return this.ensureStorageAvailable(),this.storage.getItem(this.key)!==null}async get(){return this.ensureStorageAvailable(),this.storage.getItem(this.key)}async save(t){this.ensureStorageAvailable(),this.storage.setItem(this.key,t)}async remove(){this.ensureStorageAvailable(),this.storage.removeItem(this.key)}}var re={};class dt{key;constructor(t){this.key=t}async has(){return await this.get()!==null}async get(){if(typeof process>"u"||!re)return null;const t=re[this.key];return!t||t==="your_token_here"?null:t}}var lt={};class Tt{constructor(){throw new Error("TokenManager is a static class and cannot be instantiated")}static forSessionStorage(t){if(typeof sessionStorage>"u")throw new R("Web Storage API is not available");return new ne(sessionStorage,t)}static forLocalStorage(t){if(typeof localStorage>"u")throw new R("Web Storage API is not available");return new ne(localStorage,t)}static forEnv(t){if(typeof process>"u"||!lt)throw new R("Environment variables are not available");return new dt(t)}}function wt(e){return!e||e.cachedAt===null?"not-stored":e.isExpired?"expired":"stored"}class ut{storage;key;constructor(t,s){this.storage=t,this.key=s}ensureStorageAvailable(){if(typeof this.storage>"u")throw new R("Web Storage API is not available")}async has(){return this.ensureStorageAvailable(),this.storage.getItem(this.key)!==null}async get(){return this.ensureStorageAvailable(),this.storage.getItem(this.key)}async save(t){this.ensureStorageAvailable(),this.storage.setItem(this.key,t)}async remove(){this.ensureStorageAvailable(),this.storage.removeItem(this.key)}}var oe={};class ft{key;constructor(t){this.key=t}async has(){return await this.get()!==null}async get(){if(typeof process>"u"||!oe)return null;const t=oe[this.key];return typeof t>"u"?null:t}}var ht={};class At{constructor(){throw new Error("ConfigManager is a static class and cannot be instantiated")}static forLocalStorage(t){if(typeof localStorage>"u")throw new R("Web Storage API is not available");return new ut(localStorage,t)}static forEnv(t){if(typeof process>"u"||!ht)throw new R("Environment variables are not available");return new ft(t)}}export{At as C,Tt as T,St as a,pt as c,wt as g,Et as p,yt as t};
