function w(e){const t=new URLSearchParams;if(!e)return t;const r=(o,n)=>{if(n!=null){if(typeof n=="boolean"){t.set(o,n?"true":"false");return}t.set(o,String(n))}};return r("userNm",e.userNm),r("materialNm",e.materialNm),r("tagNm",e.tagNm),r("eventNm",e.eventNm),r("eventId",e.eventId),r("awardNm",e.awardNm),r("prototypeId",e.prototypeId),r("status",e.status),r("limit",e.limit),r("offset",e.offset),t}function A(...e){const t=new Headers;for(const r of e)r&&new Headers(r).forEach((o,n)=>{t.set(n,o)});return t}function m(e){const t={};return e.forEach((r,o)=>{t[o]=r}),t}function p(e){return e.endsWith("/")?e.slice(0,-1):e}function x(e,t){return typeof e=="number"&&Number.isFinite(e)&&e>=0?e:t}function V(e){return new DOMException(`Request timed out after ${e} ms`,"TimeoutError")}function L(e){return e instanceof DOMException&&e.name==="AbortError"}class f extends Error{req;status;statusText;body;headers;constructor(t){super(t.message,{cause:t.cause}),this.name="ProtoPediaApiError",this.req={...t.req},this.status=t.status,this.statusText=t.statusText,this.body=t.body??null,this.headers={...t.headers}}toJSON(){return{name:this.name,message:this.message,req:this.req,status:this.status,statusText:this.statusText,body:this.body,headers:this.headers}}}const N={error:0,warn:1,info:2,debug:3},E={error:()=>{},warn:()=>{},info:()=>{},debug:()=>{}};function U(e,t){const r=t??"error";return{logger:S(e??_()),level:r,levelValue:h(r)}}function M(e,t){if(e<0)return!1;const r=h(t);return r<0?!1:r<=e}function h(e){return e==="silent"?-1:N[e]}function S(e){return{error:l(e.error),warn:l(e.warn,e.error),info:l(e.info,e.warn??e.error),debug:l(e.debug,e.info??e.warn??e.error)}}function l(e,t){return typeof e=="function"?u(e):typeof t=="function"?u(t):E.debug}function u(e){return(t,r)=>{r===void 0?e(t):e(t,r)}}function _(){if(typeof console!="object"||console===null)return E;const e=u(()=>{}),t=typeof console.error=="function"?u(console.error.bind(console)):e,r=typeof console.warn=="function"?u(console.warn.bind(console)):t,o=typeof console.info=="function"?u(console.info.bind(console)):r,n=typeof console.debug=="function"?u(console.debug.bind(console)):o;return{error:t,warn:r,info:o,debug:n}}function I(e,t){return e[t]}function y(e){if(!e)return;if(e instanceof Headers)return T(e);const t=new Headers(e);return T(t)}function T(e){const t={};return e.forEach((r,o)=>{const n=o.toLowerCase(),s=n.includes("token")||n.includes("auth");t[o]=s?"***":r}),t}const F="3.0.0",j=`ProtoPedia API Ver 2.0 Node.js Client/${F}`,k="https://protopedia.net/v2/api",C=15e3;class H{token;baseUrl;fetchFn;timeoutMs;userAgent;logger;logLevel;logLevelValue;constructor(t={}){const r=t.fetch??globalThis.fetch;if(typeof r!="function")throw new Error("fetch is not available. Provide a fetch implementation in options.fetch.");this.fetchFn=r,this.token=t.token,this.baseUrl=p(t.baseUrl??k),this.timeoutMs=x(t.timeoutMs,C),this.userAgent=t.userAgent??j;const o=U(t.logger,t.logLevel);this.logger=o.logger,this.logLevel=o.level,this.logLevelValue=o.levelValue}async listPrototypes(t,r){const o=this.resolveLogLevelValue(r),n=this.buildUrl("/prototype/list",w(t)),s="GET",i=await this.execute(n,{method:s,headers:{Accept:"application/json"}},r,o),c=await R(i,s,"listPrototype");return this.log("debug","listPrototype response payload",c,o),c}async downloadPrototypesTsv(t,r){const o=this.resolveLogLevelValue(r),n=this.buildUrl("/prototype/list/tsv",w(t)),c=await(await this.execute(n,{method:"GET",headers:{Accept:"application/json"}},r,o)).text();return this.log("debug","downloadPrototypesTsv response payload",c,o),c}async execute(t,r,o,n){const s=n??this.resolveLogLevelValue(o),{method:i,body:c}=r,d=A(this.token?{Authorization:`Bearer ${this.token}`}:void 0,this.userAgent?{"X-Client-User-Agent":this.userAgent}:void 0,r.headers,o?.headers),{signal:P,cleanup:v}=this.createAbortSignal(o?.signal),g={method:i,headers:d,signal:P};c!==void 0&&(g.body=c);try{this.log("debug","HTTP request",{method:i,url:t,headers:y(d)},s);const a=await this.fetchFn(t,g);if(this.log("debug","HTTP response",{method:i,url:t,status:a.status,headers:y(a.headers)},s),!a.ok){const b=await O(a,i);throw this.log("error","API request failed",b,s),b}return a}catch(a){throw a instanceof f?a:L(a)&&o?.signal?.aborted?(this.log("warn","HTTP request aborted by caller",{method:i,url:t,reason:o.signal.reason},s),o.signal.reason??a):(L(a)?this.log("warn","HTTP request aborted",{method:i,url:t,error:a},s):this.log("error","HTTP request threw an unexpected error",{method:i,url:t,error:a},s),a)}finally{v()}}buildUrl(t,r){const o=t.replace(/^\/+/,""),n=`${this.baseUrl}/`,s=new URL(o,n);return r.forEach((i,c)=>{i!==""&&s.searchParams.set(c,i)}),s.toString()}createAbortSignal(t){const r=new AbortController,o=this.timeoutMs;let n,s;Number.isFinite(o)&&o>0&&(n=setTimeout(()=>{r.abort(V(o))},o)),t&&(t.aborted?r.abort(t.reason):(s=()=>{r.abort(t.reason)},t.addEventListener("abort",s,{once:!0})));const i=()=>{n&&clearTimeout(n),t&&s&&t.removeEventListener("abort",s)};return{signal:r.signal,cleanup:i}}log(t,r,o,n){const s=n??this.logLevelValue;if(!M(s,t))return;const i=I(this.logger,t);o===void 0?i(r):i(r,o)}resolveLogLevelValue(t){return t?.logLevel?h(t.logLevel):this.logLevelValue}}function q(e={}){const t=e.token;if(t==null||!t)throw new Error("Missing PROTOPEDIA_API_V2_TOKEN.");return new H(e)}async function R(e,t,r){try{return await e.json()}catch(o){const n=await e.text();throw new f({message:`Failed to parse ${r} response as JSON`,req:{method:t,url:e.url},status:e.status,statusText:e.statusText,headers:m(e.headers),body:n,cause:o})}}async function O(e,t){let r=null;if((e.headers.get("content-type")?.toLowerCase()??"").includes("application/json"))try{r=await e.clone().json()}catch{try{r=await e.text()}catch(n){r={parseError:n.message}}}else try{r=await e.text()}catch(n){try{r=await e.json()}catch{r={parseError:n.message}}}return new f({message:"API request failed",req:{method:t,url:e.url},status:e.status,statusText:e.statusText,headers:m(e.headers),body:r})}export{f as P,q as c};
