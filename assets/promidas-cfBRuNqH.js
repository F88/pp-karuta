function Ie(e){const t=new URLSearchParams;if(!e)return t;const n=(r,o)=>{if(o!=null){if(typeof o=="boolean"){t.set(r,o?"true":"false");return}t.set(r,String(o))}};return n("userNm",e.userNm),n("materialNm",e.materialNm),n("tagNm",e.tagNm),n("eventNm",e.eventNm),n("eventId",e.eventId),n("awardNm",e.awardNm),n("prototypeId",e.prototypeId),n("status",e.status),n("limit",e.limit),n("offset",e.offset),t}function Pt(...e){const t=new Headers;for(const n of e)n&&new Headers(n).forEach((r,o)=>{t.set(o,r)});return t}function at(e){const t={};return e.forEach((n,r)=>{t[r]=n}),t}function Ot(e){return e.endsWith("/")?e.slice(0,-1):e}function At(e,t){return typeof e=="number"&&Number.isFinite(e)&&e>=0?e:t}function Lt(e){return new DOMException(`Request timed out after ${e} ms`,"TimeoutError")}function ke(e){return e instanceof DOMException&&e.name==="AbortError"}class fe extends Error{req;status;statusText;body;headers;constructor(t){super(t.message,{cause:t.cause}),this.name="ProtoPediaApiError",this.req={...t.req},this.status=t.status,this.statusText=t.statusText,this.body=t.body??null,this.headers={...t.headers}}toJSON(){return{name:this.name,message:this.message,req:this.req,status:this.status,statusText:this.statusText,body:this.body,headers:this.headers}}}const It={error:0,warn:1,info:2,debug:3},ut={error:()=>{},warn:()=>{},info:()=>{},debug:()=>{}};function kt(e,t){const n=t??"error";return{logger:Ct(e??Mt()),level:n,levelValue:ze(n)}}function Rt(e,t){if(e<0)return!1;const n=ze(t);return n<0?!1:n<=e}function ze(e){return e==="silent"?-1:It[e]}function Ct(e){return{error:ne(e.error),warn:ne(e.warn,e.error),info:ne(e.info,e.warn??e.error),debug:ne(e.debug,e.info??e.warn??e.error)}}function ne(e,t){return typeof e=="function"?j(e):typeof t=="function"?j(t):ut.debug}function j(e){return(t,n)=>{n===void 0?e(t):e(t,n)}}function Mt(){if(typeof console!="object"||console===null)return ut;const e=j(()=>{}),t=typeof console.error=="function"?j(console.error.bind(console)):e,n=typeof console.warn=="function"?j(console.warn.bind(console)):t,r=typeof console.info=="function"?j(console.info.bind(console)):n,o=typeof console.debug=="function"?j(console.debug.bind(console)):r;return{error:t,warn:n,info:r,debug:o}}function $t(e,t){return e[t]}function Re(e){if(!e)return;if(e instanceof Headers)return Ce(e);const t=new Headers(e);return Ce(t)}function Ce(e){const t={};return e.forEach((n,r)=>{const o=r.toLowerCase(),s=o.includes("token")||o.includes("auth");t[r]=s?"***":n}),t}const Dt="3.0.0",xt=`ProtoPedia API Ver 2.0 Node.js Client/${Dt}`,Ft="https://protopedia.net/v2/api",jt=15e3;class Zt{token;baseUrl;fetchFn;timeoutMs;userAgent;logger;logLevel;logLevelValue;constructor(t={}){const n=t.fetch??globalThis.fetch;if(typeof n!="function")throw new Error("fetch is not available. Provide a fetch implementation in options.fetch.");this.fetchFn=n,this.token=t.token,this.baseUrl=Ot(t.baseUrl??Ft),this.timeoutMs=At(t.timeoutMs,jt),this.userAgent=t.userAgent??xt;const r=kt(t.logger,t.logLevel);this.logger=r.logger,this.logLevel=r.level,this.logLevelValue=r.levelValue}async listPrototypes(t,n){const r=this.resolveLogLevelValue(n),o=this.buildUrl("/prototype/list",Ie(t)),s="GET",i=await this.execute(o,{method:s,headers:{Accept:"application/json"}},n,r),a=await Vt(i,s,"listPrototype");return this.log("debug","listPrototype response payload",a,r),a}async downloadPrototypesTsv(t,n){const r=this.resolveLogLevelValue(n),o=this.buildUrl("/prototype/list/tsv",Ie(t)),a=await(await this.execute(o,{method:"GET",headers:{Accept:"application/json"}},n,r)).text();return this.log("debug","downloadPrototypesTsv response payload",a,r),a}async execute(t,n,r,o){const s=o??this.resolveLogLevelValue(r),{method:i,body:a}=n,u=Pt(this.token?{Authorization:`Bearer ${this.token}`}:void 0,this.userAgent?{"X-Client-User-Agent":this.userAgent}:void 0,n.headers,r?.headers),{signal:l,cleanup:h}=this.createAbortSignal(r?.signal),g={method:i,headers:u,signal:l};a!==void 0&&(g.body=a);try{this.log("debug","HTTP request",{method:i,url:t,headers:Re(u)},s);const y=await this.fetchFn(t,g);if(this.log("debug","HTTP response",{method:i,url:t,status:y.status,headers:Re(y.headers)},s),!y.ok){const w=await Bt(y,i);throw this.log("error","API request failed",w,s),w}return y}catch(y){throw y instanceof fe?y:ke(y)&&r?.signal?.aborted?(this.log("warn","HTTP request aborted by caller",{method:i,url:t,reason:r.signal.reason},s),r.signal.reason??y):(ke(y)?this.log("warn","HTTP request aborted",{method:i,url:t,error:y},s):this.log("error","HTTP request threw an unexpected error",{method:i,url:t,error:y},s),y)}finally{h()}}buildUrl(t,n){const r=t.replace(/^\/+/,""),o=`${this.baseUrl}/`,s=new URL(r,o);return n.forEach((i,a)=>{i!==""&&s.searchParams.set(a,i)}),s.toString()}createAbortSignal(t){const n=new AbortController,r=this.timeoutMs;let o,s;Number.isFinite(r)&&r>0&&(o=setTimeout(()=>{n.abort(Lt(r))},r)),t&&(t.aborted?n.abort(t.reason):(s=()=>{n.abort(t.reason)},t.addEventListener("abort",s,{once:!0})));const i=()=>{o&&clearTimeout(o),t&&s&&t.removeEventListener("abort",s)};return{signal:n.signal,cleanup:i}}log(t,n,r,o){const s=o??this.logLevelValue;if(!Rt(s,t))return;const i=$t(this.logger,t);r===void 0?i(n):i(n,r)}resolveLogLevelValue(t){return t?.logLevel?ze(t.logLevel):this.logLevelValue}}function Ut(e={}){const t=e.token;if(t==null||!t)throw new Error("Missing PROTOPEDIA_API_V2_TOKEN.");return new Zt(e)}async function Vt(e,t,n){try{return await e.json()}catch(r){const o=await e.text();throw new fe({message:`Failed to parse ${n} response as JSON`,req:{method:t,url:e.url},status:e.status,statusText:e.statusText,headers:at(e.headers),body:o,cause:r})}}async function Bt(e,t){let n=null;if((e.headers.get("content-type")?.toLowerCase()??"").includes("application/json"))try{n=await e.clone().json()}catch{try{n=await e.text()}catch(o){n={parseError:o.message}}}else try{n=await e.text()}catch(o){try{n=await e.json()}catch{n={parseError:o.message}}}return new fe({message:"API request failed",req:{method:t,url:e.url},status:e.status,statusText:e.statusText,headers:at(e.headers),body:n})}const Me=["debug","info","warn","error","silent"],re=e=>typeof console<"u"&&typeof console[e]=="function"?console[e].bind(console):void 0;class Z{level;hasConsole;constructor(t="info"){this.level=t,this.hasConsole=typeof console<"u",this.error=this.error.bind(this),this.warn=this.warn.bind(this),this.info=this.info.bind(this),this.debug=this.debug.bind(this)}error(t,n){this.log("error",t,n,re("error"))}warn(t,n){this.log("warn",t,n,re("warn"))}info(t,n){this.log("info",t,n,re("info"))}debug(t,n){this.log("debug",t,n,re("debug"))}log(t,n,r,o){if(!this.shouldLog(t)||!this.hasConsole||!o)return;const i=`${`[${t.toUpperCase()}]`} ${n}`;r===void 0?o(i):o(i,r)}shouldLog(t){return this.level==="silent"?!1:Me.indexOf(t)>=Me.indexOf(this.level)}}const Wt=540*60*1e3;function Jt(e){if(typeof e!="string"||e.length===0)return;const t=e.match(/^(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})\.(\d+)$/);if(!t)return;const[,n,r,o,s,i,a,u]=t,l=Number(n),h=Number(r),g=Number(o),y=Number(s),w=Number(i),T=Number(a),k=u.padEnd(3,"0").slice(0,3),C=Number(k);if([l,h,g,y,w,T,C].some(F=>Number.isNaN(F)))return;const x=Date.UTC(l,h-1,g,y,w,T,C)-Wt;return Number.isFinite(x)?new Date(x).toISOString():void 0}function Ht(e){if(typeof e!="string"||e.length===0||!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}(:\d{2})?(\.\d+)?([Zz]|[+-]\d{2}:\d{2})$/.test(e))return;const n=new Date(e);if(!Number.isNaN(n.getTime()))return n.toISOString()}function $e(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}const De=100;function ue(e,t,n=new WeakSet,r=0){if(r>De)return console.warn(`deepMerge: Maximum depth (${De}) exceeded`),e;const o={...e};for(const s of Object.keys(t)){if(s==="__proto__"||s==="constructor"||s==="prototype")continue;const i=t[s],a=e[s];if($e(i)){if(n.has(i))continue;n.add(i);const u=$e(a)?a:{};o[s]=ue(u,i,n,r+1),n.delete(i)}else i!==void 0&&(Array.isArray(i)?o[s]=[...i]:o[s]=i)}return o}const ct=["token","auth","password","secret","credential"],Kt=new RegExp(ct.join("|"),"i"),Gt=new Set(["__proto__","constructor","prototype"]),qt=100,xe=new Map,Fe=100;function Yt(e){for(const t of e){if(typeof t!="string")throw new TypeError(`Invalid sensitive key: expected string, got ${typeof t}`);if(t.length===0)throw new TypeError("Sensitive key cannot be empty");if(t.length>Fe)throw new TypeError(`Sensitive key too long (max ${Fe} characters): ${t.slice(0,20)}...`);if(/[*+{].*[*+{]/.test(t))throw new TypeError(`Potentially dangerous regex pattern detected: ${t}`)}}function Xt(e=[]){if(e.length===0)return Kt;Yt(e);const n=[...ct,...e].sort().join("|");let r=xe.get(n);return r||(r=new RegExp(n,"i"),xe.set(n,r)),r}function P(e,t={}){const n=new WeakSet,r=Xt(t.additionalSensitiveKeys);function o(a){return r.test(a)}const s=new Set(["name","message","stack"]);function i(a,u=0){if(u>=qt)return"[Max Depth Exceeded]";if(a===null||typeof a!="object")return typeof a=="function"?`[Function: ${a.name||"anonymous"}]`:typeof a=="symbol"?a.toString():typeof a=="bigint"?`${a.toString()}n`:a;if(n.has(a))return"[Circular]";if(n.add(a),a instanceof Error){const g={name:a.name,message:a.message,stack:a.stack};for(const y of Object.getOwnPropertyNames(a))if(!s.has(y))if(o(y))g[y]="***";else{const w=a;g[y]=i(w[y],u+1)}return g}if(a instanceof Map)return{__type:"Map",entries:Array.from(a.entries()).map(([g,y])=>{const w=typeof g=="string"&&o(g),T=w?"***":i(g,u+1),k=w?"***":i(y,u+1);return[T,k]})};if(a instanceof Set)return{__type:"Set",values:Array.from(a).map(g=>i(g,u+1))};if(Array.isArray(a))return a.map(g=>i(g,u+1));const l={},h=a;for(const g of Object.keys(h))Gt.has(g)||(o(g)?l[g]="***":l[g]=i(h[g],u+1));return l}return i(e)}const lt="1.0.0";class ft extends Error{timeoutMs;constructor(t,n){super(n??`Upstream request timed out after ${t}ms`),Object.setPrototypeOf(this,new.target.prototype),this.name="PromidasTimeoutError",this.timeoutMs=t}}function Qt(e){return e instanceof DOMException&&e.name==="AbortError"}function en(e){const{timeoutMs:t,baseFetch:n}=e;return async(r,o)=>{const s=n??globalThis.fetch,i=new AbortController,a=new ft(t),u=()=>{i.abort(o?.signal?.reason)};o?.signal?.aborted?u():o?.signal&&o.signal.addEventListener("abort",u,{once:!0});const l=setTimeout(()=>{i.abort(a)},t);try{return await s(r,{...o,signal:i.signal})}catch(h){throw h===a?h:Qt(h)&&i.signal.reason===a?a:h}finally{clearTimeout(l),o?.signal&&o.signal.removeEventListener("abort",u)}}}function J(e){if("level"in e&&typeof e.level=="string"){const t=e.level;return t==="debug"||t==="info"}return!0}function tn(e){try{const n=new URL(e).searchParams.get("limit");if(!n)return{estimatedSize:0,itemCount:0};const r=parseInt(n,10);return isNaN(r)||r<=0?{estimatedSize:0,itemCount:0}:{estimatedSize:r*2670,itemCount:r}}catch{return{estimatedSize:0,itemCount:0}}}function nn(e){const{logger:t,enableProgressLog:n,baseFetch:r,onProgressEvent:o}=e;return async(s,i)=>{let a=-1,u=0,l=0,h=!1,g=0;const y=Date.now();n&&J(t)&&t.info("Request starting..."),o?.({type:"request-start"});const T=await(r??globalThis.fetch)(s,i),k=Date.now(),C=k-y,x=T.headers.get("Content-Length");let z=x?parseInt(x,10):0;isNaN(z)&&(z=0);const F=tn(s.toString());if(g=F.itemCount,z===0&&(z=F.estimatedSize,h=z>0),n&&z>0&&J(t)){const p=h?" (estimated)":"";t.info(`Response received (${C}ms) - ${z} bytes${p}, limit=${g}`)}if(o?.({type:"response-received",prepareTimeMs:C,estimatedTotal:z,limit:g}),!T.body){const m=Date.now()-y;if(n&&J(t)){const b=h?`Download complete: 0 bytes received (estimated ${z} bytes) in 0ms (total: ${m}ms)`:`Download complete: 0 / ${z} bytes received in 0ms (total: ${m}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${b}
`):t.info(b)}return o?.({type:"complete",received:0,estimatedTotal:z,downloadTimeMs:0,totalTimeMs:m}),T}const f=T.body.getReader();let c=0;const d=new ReadableStream({async start(p){try{for(;;){const{done:m,value:b}=await f.read();if(m){const B=Date.now(),Y=B-y,W=B-k;if(n&&J(t)){const Le=h?`Download complete: ${c} bytes received (estimated ${z} bytes) in ${W}ms (total: ${Y}ms)`:`Download complete: ${c} / ${z} bytes received in ${W}ms (total: ${Y}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${Le}
`):t.info(Le)}o?.({type:"complete",received:c,estimatedTotal:z,downloadTimeMs:W,totalTimeMs:Y}),p.close();break}c+=b.length;const v=z>0?c/z*100:0,S=Date.now(),M=S-l,D=l===0;if(D||M>=500){if(n&&J(t)){const B=c-u,Y=h&&D?" (estimated)":"",W=`Download progress: ${v.toFixed(1)}%${Y} (${c} / ${z} bytes, +${B})`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${W}`):t.info(W)}o?.({type:"download-progress",received:c,total:z,percentage:v}),a=v,u=c,l=S}p.enqueue(b)}}catch(m){const b=Date.now(),v=b-y,S=b-k,M=m instanceof Error?m.message:String(m);if(n&&J(t)){const D=`Download error: ${M} (${v}ms)`;typeof process<"u"&&process.stderr?.write?process.stderr.write(`\r${D}
`):t.error(D)}o?.({type:"error",error:M,received:c,estimatedTotal:z,downloadTimeMs:S,totalTimeMs:v}),p.error(m)}}});return new Response(d,{status:T.status,statusText:T.statusText,headers:T.headers})}}function rn(e){const{logger:t,enableProgressLog:n,baseFetch:r,onProgressEvent:o}=e;return n||o!==void 0?nn({logger:t,enableProgressLog:n,...r!==void 0&&{baseFetch:r},...o!==void 0&&{onProgressEvent:o}}):r}function on(e){return e.map(t=>t.trim()).filter(t=>t!=="").map(t=>t.toLowerCase())}function sn(e){const{baseFetch:t}=e,n=on(e.headerNames);return async(r,o)=>{if(n.length===0)return t(r,o);if(typeof Request<"u"&&r instanceof Request){const s=new Headers(r.headers);o?.headers!==void 0&&new Headers(o.headers).forEach((u,l)=>{s.set(l,u)});for(const a of n)s.delete(a);const i=new Request(r,{headers:s});return o!==void 0?t(i,{...o,headers:s}):t(i)}if(o?.headers!==void 0){const s=new Headers(o.headers);for(const i of n)s.delete(i);return t(r,{...o,headers:s})}return t(r,o)}}function an(e){const{logger:t,enableProgressLog:n,progressCallback:r,timeoutMs:o,providedFetch:s,stripHeaders:i}=e,a=typeof o=="number"?en({timeoutMs:o,baseFetch:s}):s,u=Array.isArray(i)&&i.length>0,l=u?a??(typeof globalThis.fetch=="function"?globalThis.fetch:void 0):void 0,h=u?l!==void 0?sn({baseFetch:l,headerNames:i}):void 0:a;return rn({logger:t,enableProgressLog:n,...h!==void 0&&{baseFetch:h},...r!==void 0&&{onProgressEvent:r}})}const un={ABORT:"AbortError"},me={ABORTED:"Upstream request aborted",TIMEOUT:"Upstream request timed out",UNKNOWN:"Failed to fetch prototypes"},cn="NETWORK_ERROR",ln=new Set(["Failed to fetch","fetch failed","Load failed","NetworkError when attempting to fetch resource."]),fn={400:"CLIENT_BAD_REQUEST",401:"CLIENT_UNAUTHORIZED",403:"CLIENT_FORBIDDEN",404:"CLIENT_NOT_FOUND",405:"CLIENT_METHOD_NOT_ALLOWED",408:"CLIENT_TIMEOUT",429:"CLIENT_RATE_LIMITED",500:"SERVER_INTERNAL_ERROR",502:"SERVER_BAD_GATEWAY",503:"SERVER_SERVICE_UNAVAILABLE",504:"SERVER_GATEWAY_TIMEOUT"};function dn(e){return e instanceof DOMException&&e.name===un.ABORT}function hn(e){return e!==null&&typeof e=="object"}function H(e,t,n){const r={ok:!1,origin:"fetcher",error:e,details:t};return n!==void 0&&(r.status=n),r}function pn(e){if(e===void 0)return"UNKNOWN";const t=fn[e];return t!==void 0?t:e>=500&&e<600?"SERVER_ERROR":e>=400&&e<500?"CLIENT_ERROR":"UNKNOWN"}function K(e,t,n){return{...e,kind:t,code:n}}function mn(e){const t=H(e.message,{req:{url:e.req.url,method:e.req.method},res:{statusText:e.statusText}},e.status);return K(t,"http",pn(e.status))}function gn(e){if(e instanceof ft){const s=H(me.TIMEOUT,{res:{code:"TIMEOUT"}});return K(s,"timeout","TIMEOUT")}if(dn(e)){const s=H(me.ABORTED,{res:{code:"ABORTED"}});return K(s,"abort","ABORTED")}const t=e instanceof Error?e.message:me.UNKNOWN,n={};if(hn(e)){const s=e,i=s.code??s.cause?.code;i!==void 0&&(n.res??={},n.res.code=i)}const r=e instanceof TypeError&&ln.has(t);if(n.res?.code===void 0&&r){n.res??={},n.res.code=cn;const s=H(t,n);return K(s,"cors","CORS_BLOCKED")}if(n.res?.code!==void 0){const s=H(t,n),i=n.res.code;return K(s,"network",i)}const o=H(t,n);return K(o,"unknown","UNKNOWN")}function yn(e){return e instanceof fe?mn(e):gn(e)}function _n(e){const{logger:t,original:n,normalized:r,index:o}=e,s={prototypeId:n.id,index:o};n.createDate&&r.createDate===n.createDate&&!r.createDate.endsWith("Z")&&t.warn("Failed to parse and normalize createDate",{...s,originalValue:n.createDate}),n.updateDate&&r.updateDate===n.updateDate&&!r.updateDate.endsWith("Z")&&t.warn("Failed to parse and normalize updateDate",{...s,originalValue:n.updateDate}),n.releaseDate&&r.releaseDate===n.releaseDate&&!r.releaseDate.endsWith("Z")&&t.warn("Failed to parse and normalize releaseDate",{...s,originalValue:n.releaseDate})}function ge(e){if(e===null)return null;if(e===void 0)return;const t=Jt(e);if(t!==void 0)return t;const n=Ht(e);return n!==void 0?n:e}const X=e=>typeof e!="string"||e.length===0?[]:e.split("|").map(t=>t.trim()).filter(t=>t.length>0);function vn(e){const t=ge(e.createDate)??e.createDate,n=ge(e.updateDate)??e.updateDate,r=ge(e.releaseDate)??void 0;return{id:e.id,createDate:t,updateDate:n,releaseDate:r,createId:e.createId,updateId:e.updateId,releaseFlg:e.releaseFlg??2,status:e.status,prototypeNm:e.prototypeNm,summary:e.summary??"",freeComment:e.freeComment??"",systemDescription:e.systemDescription??"",users:X(e.users),teamNm:e.teamNm??"",tags:X(e.tags),materials:X(e.materials),events:X(e.events),awards:X(e.awards),officialLink:e.officialLink,videoUrl:e.videoUrl,mainUrl:e.mainUrl,relatedLink:e.relatedLink,relatedLink2:e.relatedLink2,relatedLink3:e.relatedLink3,relatedLink4:e.relatedLink4,relatedLink5:e.relatedLink5,viewCount:e.viewCount,goodCount:e.goodCount,commentCount:e.commentCount,uuid:e.uuid,nid:e.nid,revision:e.revision??0,licenseType:e.licenseType??1,thanksFlg:e.thanksFlg??0,slideMode:e.slideMode}}class bn{#e;#n;#t;constructor(t){const{protoPediaApiClientOptions:n={},logger:r,logLevel:o,progressLog:s=!0,progressCallback:i}=t??{},{timeoutMs:a,fetch:u,...l}=n;if(r)this.#n=r,this.#t=o??"info",o!==void 0&&"level"in r&&(r.level=o);else{const C=o??"info";this.#n=new Z(C),this.#t=C}this.#n.info("ProtopediaApiCustomClient constructor called",P(t));const h=typeof globalThis.window<"u",g=typeof globalThis.document<"u",y=h&&g,w=l.userAgent??`ProtopediaApiCustomClient/${lt} (promidas)`,T=y?["x-client-user-agent"]:void 0,k=an({logger:this.#n,enableProgressLog:s,progressCallback:i,timeoutMs:a,providedFetch:u,stripHeaders:T});this.#e=Ut({...l,userAgent:w,...k!==void 0&&{fetch:k}})}async#o(t){try{const n=await this.#e.listPrototypes(t);let r=[];return Array.isArray(n.results)?r=n.results.map((o,s)=>{const i=o,a=vn(i);return _n({logger:this.#n,original:i,normalized:a,index:s}),a}):this.#n.warn('Upstream API response "results" is not an array. Returning empty data.',{upstreamResults:n.results,params:t}),this.#n.debug(`Successfully fetched ${r.length} prototypes.`,{params:t}),{ok:!0,data:r}}catch(n){const r=yn(n);if(!r.ok){const o=P(r);r.status===void 0||r.status>=500?this.#n.error(r.error,o):this.#n.warn(r.error,o)}return r}}async fetchPrototypes(t){return this.#o(t)}async listPrototypes(t){return this.#e.listPrototypes(t)}}var oe={exports:{}},je;function wn(){if(je)return oe.exports;je=1;var e=typeof Reflect=="object"?Reflect:null,t=e&&typeof e.apply=="function"?e.apply:function(c,d,p){return Function.prototype.apply.call(c,d,p)},n;e&&typeof e.ownKeys=="function"?n=e.ownKeys:Object.getOwnPropertySymbols?n=function(c){return Object.getOwnPropertyNames(c).concat(Object.getOwnPropertySymbols(c))}:n=function(c){return Object.getOwnPropertyNames(c)};function r(f){console&&console.warn&&console.warn(f)}var o=Number.isNaN||function(c){return c!==c};function s(){s.init.call(this)}oe.exports=s,oe.exports.once=x,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var i=10;function a(f){if(typeof f!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof f)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return i},set:function(f){if(typeof f!="number"||f<0||o(f))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+f+".");i=f}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(c){if(typeof c!="number"||c<0||o(c))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+c+".");return this._maxListeners=c,this};function u(f){return f._maxListeners===void 0?s.defaultMaxListeners:f._maxListeners}s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(c){for(var d=[],p=1;p<arguments.length;p++)d.push(arguments[p]);var m=c==="error",b=this._events;if(b!==void 0)m=m&&b.error===void 0;else if(!m)return!1;if(m){var v;if(d.length>0&&(v=d[0]),v instanceof Error)throw v;var S=new Error("Unhandled error."+(v?" ("+v.message+")":""));throw S.context=v,S}var M=b[c];if(M===void 0)return!1;if(typeof M=="function")t(M,this,d);else for(var D=M.length,B=T(M,D),p=0;p<D;++p)t(B[p],this,d);return!0};function l(f,c,d,p){var m,b,v;if(a(d),b=f._events,b===void 0?(b=f._events=Object.create(null),f._eventsCount=0):(b.newListener!==void 0&&(f.emit("newListener",c,d.listener?d.listener:d),b=f._events),v=b[c]),v===void 0)v=b[c]=d,++f._eventsCount;else if(typeof v=="function"?v=b[c]=p?[d,v]:[v,d]:p?v.unshift(d):v.push(d),m=u(f),m>0&&v.length>m&&!v.warned){v.warned=!0;var S=new Error("Possible EventEmitter memory leak detected. "+v.length+" "+String(c)+" listeners added. Use emitter.setMaxListeners() to increase limit");S.name="MaxListenersExceededWarning",S.emitter=f,S.type=c,S.count=v.length,r(S)}return f}s.prototype.addListener=function(c,d){return l(this,c,d,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(c,d){return l(this,c,d,!0)};function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function g(f,c,d){var p={fired:!1,wrapFn:void 0,target:f,type:c,listener:d},m=h.bind(p);return m.listener=d,p.wrapFn=m,m}s.prototype.once=function(c,d){return a(d),this.on(c,g(this,c,d)),this},s.prototype.prependOnceListener=function(c,d){return a(d),this.prependListener(c,g(this,c,d)),this},s.prototype.removeListener=function(c,d){var p,m,b,v,S;if(a(d),m=this._events,m===void 0)return this;if(p=m[c],p===void 0)return this;if(p===d||p.listener===d)--this._eventsCount===0?this._events=Object.create(null):(delete m[c],m.removeListener&&this.emit("removeListener",c,p.listener||d));else if(typeof p!="function"){for(b=-1,v=p.length-1;v>=0;v--)if(p[v]===d||p[v].listener===d){S=p[v].listener,b=v;break}if(b<0)return this;b===0?p.shift():k(p,b),p.length===1&&(m[c]=p[0]),m.removeListener!==void 0&&this.emit("removeListener",c,S||d)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(c){var d,p,m;if(p=this._events,p===void 0)return this;if(p.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):p[c]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete p[c]),this;if(arguments.length===0){var b=Object.keys(p),v;for(m=0;m<b.length;++m)v=b[m],v!=="removeListener"&&this.removeAllListeners(v);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(d=p[c],typeof d=="function")this.removeListener(c,d);else if(d!==void 0)for(m=d.length-1;m>=0;m--)this.removeListener(c,d[m]);return this};function y(f,c,d){var p=f._events;if(p===void 0)return[];var m=p[c];return m===void 0?[]:typeof m=="function"?d?[m.listener||m]:[m]:d?C(m):T(m,m.length)}s.prototype.listeners=function(c){return y(this,c,!0)},s.prototype.rawListeners=function(c){return y(this,c,!1)},s.listenerCount=function(f,c){return typeof f.listenerCount=="function"?f.listenerCount(c):w.call(f,c)},s.prototype.listenerCount=w;function w(f){var c=this._events;if(c!==void 0){var d=c[f];if(typeof d=="function")return 1;if(d!==void 0)return d.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]};function T(f,c){for(var d=new Array(c),p=0;p<c;++p)d[p]=f[p];return d}function k(f,c){for(;c+1<f.length;c++)f[c]=f[c+1];f.pop()}function C(f){for(var c=new Array(f.length),d=0;d<c.length;++d)c[d]=f[d].listener||f[d];return c}function x(f,c){return new Promise(function(d,p){function m(v){f.removeListener(c,b),p(v)}function b(){typeof f.removeListener=="function"&&f.removeListener("error",m),d([].slice.call(arguments))}F(f,c,b,{once:!0}),c!=="error"&&z(f,m,{once:!0})})}function z(f,c,d){typeof f.on=="function"&&F(f,"error",c,d)}function F(f,c,d,p){if(typeof f.on=="function")p.once?f.once(c,d):f.on(c,d);else if(typeof f.addEventListener=="function")f.addEventListener(c,function m(b){p.once&&f.removeEventListener(c,m),d(b)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof f)}return oe.exports}var En=wn();class de extends Error{dataState;constructor(t,n="UNKNOWN",r){super(t,r),this.name="StoreError",this.dataState=n}}class zn extends de{constructor(t){super(t,"UNKNOWN"),this.name="ConfigurationError"}}class Te extends de{dataSizeBytes;maxDataSizeBytes;constructor(t,n,r){super(`Snapshot data size (${n} bytes) exceeds maximum limit (${r} bytes)`,t),this.name="DataSizeExceededError",this.dataSizeBytes=n,this.maxDataSizeBytes=r}}class ee extends de{constructor(t="UNKNOWN",n){super("Failed to estimate data size for snapshot",t,{cause:n}),this.name="SizeEstimationError"}}const Tn=1800*1e3,Sn=10*1024*1024,ce=30*1024*1024;class Nn{logger;logLevel;ttlMs;maxDataSizeBytes;prototypeIdIndex=new Map;prototypes=[];cachedAt=null;dataSizeBytes=0;refreshPromise=null;constructor({ttlMs:t=Tn,maxDataSizeBytes:n=Sn,logger:r,logLevel:o}={}){if(this.ttlMs=t,this.maxDataSizeBytes=n,r)this.logger=r,this.logLevel=o??"info",o!==void 0&&"level"in r&&(r.level=o);else{const s=o??"info";this.logger=new Z(s),this.logLevel=s}if(this.logger.info("PrototypeInMemoryStore constructor called",{ttlMs:t,maxDataSizeBytes:n,logger:r?"custom":void 0,logLevel:o}),n>ce){const s=(ce/1048576).toFixed(0);throw new zn(`PrototypeInMemoryStore maxDataSizeBytes must be <= ${ce} bytes (${s} MiB) to prevent oversized data`)}}getConfig(){return{ttlMs:this.ttlMs,maxDataSizeBytes:this.maxDataSizeBytes,logLevel:this.logLevel}}get size(){return this.prototypeIdIndex.size}getCachedAt(){return this.cachedAt}getElapsedTime(){return this.cachedAt?Date.now()-this.cachedAt.getTime():0}getRemainingTtl(){if(!this.cachedAt)return 0;const t=this.getElapsedTime(),n=this.ttlMs-t;return Math.max(0,n)}isExpired(){return this.cachedAt?this.getElapsedTime()>this.ttlMs:!0}isRefreshInFlight(){return this.refreshPromise!==null}getStats(){return{size:this.prototypeIdIndex.size,cachedAt:this.cachedAt,isExpired:this.isExpired(),remainingTtlMs:this.getRemainingTtl(),dataSizeBytes:this.dataSizeBytes,refreshInFlight:this.isRefreshInFlight()}}estimateSize(t){try{if(t.length===0)return 2;let n=2+(t.length-1);if(typeof Buffer<"u")for(const r of t)n+=Buffer.byteLength(JSON.stringify(r),"utf8");else if(typeof TextEncoder<"u"){const r=new TextEncoder;for(const o of t)n+=r.encode(JSON.stringify(o)).length}else return this.logger.warn("Neither Buffer nor TextEncoder found for size estimation. Returning 0.",{}),0;return n}catch(n){throw this.logger.error("Failed to estimate payload size",{error:P(n)}),new ee("UNKNOWN",n instanceof Error?n:void 0)}}runExclusive(t){return this.refreshPromise?this.refreshPromise:(this.refreshPromise=(async()=>{try{await t()}catch(n){throw this.logger.error("PrototypeInMemoryStore refresh task failed",{error:P(n)}),n}finally{this.refreshPromise=null}})(),this.refreshPromise)}clear(){const t=this.prototypeIdIndex.size;this.prototypeIdIndex.clear(),this.prototypes=[],this.cachedAt=null,this.dataSizeBytes=0,this.logger.info("PrototypeInMemoryStore cleared",{previousSize:t})}setAll(t){const n=new Map(t.map(s=>[s.id,s]));n.size!==t.length&&this.logger.warn("Duplicate prototype IDs detected in snapshot",{inputCount:t.length,storedCount:n.size});const r=Array.from(n.values()),o=(()=>{try{return this.estimateSize(r)}catch(s){throw s instanceof ee?new ee("UNCHANGED",s.cause):s}})();if(o>this.maxDataSizeBytes)throw this.logger.warn("Snapshot rejected: data exceeds maximum size",{dataSizeBytes:o,maxDataSizeBytes:this.maxDataSizeBytes,inputCount:t.length,uniqueCount:n.size}),new Te("UNCHANGED",o,this.maxDataSizeBytes);return this.prototypeIdIndex=n,this.prototypes=r,this.cachedAt=new Date,this.dataSizeBytes=o,this.logger.info("PrototypeInMemoryStore snapshot updated",{count:this.prototypeIdIndex.size,dataSizeBytes:o}),{dataSizeBytes:o}}getAll(){return this.prototypes}getSnapshot(){return{data:this.getAll(),cachedAt:this.cachedAt,isExpired:this.isExpired()}}getByPrototypeId(t){return this.prototypeIdIndex.get(t)??null}getPrototypeIds(){return Array.from(this.prototypeIdIndex.keys())}}class Ze extends Error{field;constructor(t,n,r){super(t,r),this.name="ValidationError",this.field=n}}function _(e,t,n){function r(a,u){if(a._zod||Object.defineProperty(a,"_zod",{value:{def:u,constr:i,traits:new Set},enumerable:!1}),a._zod.traits.has(e))return;a._zod.traits.add(e),t(a,u);const l=i.prototype,h=Object.keys(l);for(let g=0;g<h.length;g++){const y=h[g];y in a||(a[y]=l[y].bind(a))}}const o=n?.Parent??Object;class s extends o{}Object.defineProperty(s,"name",{value:e});function i(a){var u;const l=n?.Parent?new s:this;r(l,a),(u=l._zod).deferred??(u.deferred=[]);for(const h of l._zod.deferred)h();return l}return Object.defineProperty(i,"init",{value:r}),Object.defineProperty(i,Symbol.hasInstance,{value:a=>n?.Parent&&a instanceof n.Parent?!0:a?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}class q extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class dt extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const Pn={};function U(e){return Pn}function be(e,t){return typeof t=="bigint"?t.toString():t}function Se(e){return e==null}function Ne(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function On(e,t){const n=(e.toString().split(".")[1]||"").length,r=t.toString();let o=(r.split(".")[1]||"").length;if(o===0&&/\d?e-\d?/.test(r)){const u=r.match(/\d?e-(\d?)/);u?.[1]&&(o=Number.parseInt(u[1]))}const s=n>o?n:o,i=Number.parseInt(e.toFixed(s).replace(".","")),a=Number.parseInt(t.toFixed(s).replace(".",""));return i%a/10**s}const Ue=Symbol("evaluating");function E(e,t,n){let r;Object.defineProperty(e,t,{get(){if(r!==Ue)return r===void 0&&(r=Ue,r=n()),r},set(o){Object.defineProperty(e,t,{value:o})},configurable:!0})}function An(...e){const t={};for(const n of e){const r=Object.getOwnPropertyDescriptors(n);Object.assign(t,r)}return Object.defineProperties({},t)}const ht="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Ve(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function we(e){if(Ve(e)===!1)return!1;const t=e.constructor;if(t===void 0||typeof t!="function")return!0;const n=t.prototype;return!(Ve(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function pt(e){return we(e)?{...e}:Array.isArray(e)?[...e]:e}function Ln(e,t,n){const r=new e._zod.constr(t??e._zod.def);return(!t||n?.parent)&&(r._zod.parent=e),r}function A(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}const In={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function G(e,t=0){if(e.aborted===!0)return!0;for(let n=t;n<e.issues.length;n++)if(e.issues[n]?.continue!==!0)return!0;return!1}function kn(e,t){return t.map(n=>{var r;return(r=n).path??(r.path=[]),n.path.unshift(e),n})}function se(e){return typeof e=="string"?e:e?.message}function V(e,t,n){const r={...e,path:e.path??[]};if(!e.message){const o=se(e.inst?._zod.def?.error?.(e))??se(t?.error?.(e))??se(n.customError?.(e))??se(n.localeError?.(e))??"Invalid input";r.message=o}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}function Pe(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function te(...e){const[t,n,r]=e;return typeof t=="string"?{message:t,code:"custom",input:n,inst:r}:{...t}}const mt=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,be,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},gt=_("$ZodError",mt),yt=_("$ZodError",mt,{Parent:Error});function Rn(e,t=n=>n.message){const n={},r=[];for(const o of e.issues)o.path.length>0?(n[o.path[0]]=n[o.path[0]]||[],n[o.path[0]].push(t(o))):r.push(t(o));return{formErrors:r,fieldErrors:n}}function Cn(e,t=n=>n.message){const n={_errors:[]},r=o=>{for(const s of o.issues)if(s.code==="invalid_union"&&s.errors.length)s.errors.map(i=>r({issues:i}));else if(s.code==="invalid_key")r({issues:s.issues});else if(s.code==="invalid_element")r({issues:s.issues});else if(s.path.length===0)n._errors.push(t(s));else{let i=n,a=0;for(;a<s.path.length;){const u=s.path[a];a===s.path.length-1?(i[u]=i[u]||{_errors:[]},i[u]._errors.push(t(s))):i[u]=i[u]||{_errors:[]},i=i[u],a++}}};return r(e),n}const Oe=e=>(t,n,r,o)=>{const s=r?Object.assign(r,{async:!1}):{async:!1},i=t._zod.run({value:n,issues:[]},s);if(i instanceof Promise)throw new q;if(i.issues.length){const a=new(o?.Err??e)(i.issues.map(u=>V(u,s,U())));throw ht(a,o?.callee),a}return i.value},Ae=e=>async(t,n,r,o)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},s);if(i instanceof Promise&&(i=await i),i.issues.length){const a=new(o?.Err??e)(i.issues.map(u=>V(u,s,U())));throw ht(a,o?.callee),a}return i.value},he=e=>(t,n,r)=>{const o=r?{...r,async:!1}:{async:!1},s=t._zod.run({value:n,issues:[]},o);if(s instanceof Promise)throw new q;return s.issues.length?{success:!1,error:new(e??gt)(s.issues.map(i=>V(i,o,U())))}:{success:!0,data:s.value}},Mn=he(yt),pe=e=>async(t,n,r)=>{const o=r?Object.assign(r,{async:!0}):{async:!0};let s=t._zod.run({value:n,issues:[]},o);return s instanceof Promise&&(s=await s),s.issues.length?{success:!1,error:new e(s.issues.map(i=>V(i,o,U())))}:{success:!0,data:s.value}},$n=pe(yt),Dn=e=>(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Oe(e)(t,n,o)},xn=e=>(t,n,r)=>Oe(e)(t,n,r),Fn=e=>async(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Ae(e)(t,n,o)},jn=e=>async(t,n,r)=>Ae(e)(t,n,r),Zn=e=>(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return he(e)(t,n,o)},Un=e=>(t,n,r)=>he(e)(t,n,r),Vn=e=>async(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return pe(e)(t,n,o)},Bn=e=>async(t,n,r)=>pe(e)(t,n,r),Wn=/^-?\d+$/,Jn=/^-?\d+(?:\.\d+)?/,$=_("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),_t={number:"number",bigint:"bigint",object:"date"},vt=_("$ZodCheckLessThan",(e,t)=>{$.init(e,t);const n=_t[typeof t.value];e._zod.onattach.push(r=>{const o=r._zod.bag,s=(t.inclusive?o.maximum:o.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<s&&(t.inclusive?o.maximum=t.value:o.exclusiveMaximum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value<=t.value:r.value<t.value)||r.issues.push({origin:n,code:"too_big",maximum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),bt=_("$ZodCheckGreaterThan",(e,t)=>{$.init(e,t);const n=_t[typeof t.value];e._zod.onattach.push(r=>{const o=r._zod.bag,s=(t.inclusive?o.minimum:o.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>s&&(t.inclusive?o.minimum=t.value:o.exclusiveMinimum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value>=t.value:r.value>t.value)||r.issues.push({origin:n,code:"too_small",minimum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Hn=_("$ZodCheckMultipleOf",(e,t)=>{$.init(e,t),e._zod.onattach.push(n=>{var r;(r=n._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof n.value=="bigint"?n.value%t.value===BigInt(0):On(n.value,t.value)===0)||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),Kn=_("$ZodCheckNumberFormat",(e,t)=>{$.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),r=n?"int":"number",[o,s]=In[t.format];e._zod.onattach.push(i=>{const a=i._zod.bag;a.format=t.format,a.minimum=o,a.maximum=s,n&&(a.pattern=Wn)}),e._zod.check=i=>{const a=i.value;if(n){if(!Number.isInteger(a)){i.issues.push({expected:r,format:t.format,code:"invalid_type",continue:!1,input:a,inst:e});return}if(!Number.isSafeInteger(a)){a>0?i.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}):i.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort});return}}a<o&&i.issues.push({origin:"number",input:a,code:"too_small",minimum:o,inclusive:!0,inst:e,continue:!t.abort}),a>s&&i.issues.push({origin:"number",input:a,code:"too_big",maximum:s,inst:e})}}),Gn=_("$ZodCheckMaxLength",(e,t)=>{var n;$.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Se(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<o&&(r._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const o=r.value;if(o.length<=t.maximum)return;const i=Pe(o);r.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:o,inst:e,continue:!t.abort})}}),qn=_("$ZodCheckMinLength",(e,t)=>{var n;$.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Se(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>o&&(r._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const o=r.value;if(o.length>=t.minimum)return;const i=Pe(o);r.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:o,inst:e,continue:!t.abort})}}),Yn=_("$ZodCheckLengthEquals",(e,t)=>{var n;$.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Se(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag;o.minimum=t.length,o.maximum=t.length,o.length=t.length}),e._zod.check=r=>{const o=r.value,s=o.length;if(s===t.length)return;const i=Pe(o),a=s>t.length;r.issues.push({origin:i,...a?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),Xn=_("$ZodCheckOverwrite",(e,t)=>{$.init(e,t),e._zod.check=n=>{n.value=t.tx(n.value)}}),Qn={major:4,minor:2,patch:1},L=_("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Qn;const r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(const o of r)for(const s of o._zod.onattach)s(e);if(r.length===0)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const o=(i,a,u)=>{let l=G(i),h;for(const g of a){if(g._zod.def.when){if(!g._zod.def.when(i))continue}else if(l)continue;const y=i.issues.length,w=g._zod.check(i);if(w instanceof Promise&&u?.async===!1)throw new q;if(h||w instanceof Promise)h=(h??Promise.resolve()).then(async()=>{await w,i.issues.length!==y&&(l||(l=G(i,y)))});else{if(i.issues.length===y)continue;l||(l=G(i,y))}}return h?h.then(()=>i):i},s=(i,a,u)=>{if(G(i))return i.aborted=!0,i;const l=o(a,r,u);if(l instanceof Promise){if(u.async===!1)throw new q;return l.then(h=>e._zod.parse(h,u))}return e._zod.parse(l,u)};e._zod.run=(i,a)=>{if(a.skipChecks)return e._zod.parse(i,a);if(a.direction==="backward"){const l=e._zod.parse({value:i.value,issues:[]},{...a,skipChecks:!0});return l instanceof Promise?l.then(h=>s(h,i,a)):s(l,i,a)}const u=e._zod.parse(i,a);if(u instanceof Promise){if(a.async===!1)throw new q;return u.then(l=>o(l,r,a))}return o(u,r,a)}}e["~standard"]={validate:o=>{try{const s=Mn(e,o);return s.success?{value:s.data}:{issues:s.error?.issues}}catch{return $n(e,o).then(i=>i.success?{value:i.data}:{issues:i.error?.issues})}},vendor:"zod",version:1}}),wt=_("$ZodNumber",(e,t)=>{L.init(e,t),e._zod.pattern=e._zod.bag.pattern??Jn,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=Number(n.value)}catch{}const o=n.value;if(typeof o=="number"&&!Number.isNaN(o)&&Number.isFinite(o))return n;const s=typeof o=="number"?Number.isNaN(o)?"NaN":Number.isFinite(o)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:o,inst:e,...s?{received:s}:{}}),n}}),er=_("$ZodNumberFormat",(e,t)=>{Kn.init(e,t),wt.init(e,t)});function Be(e,t,n){e.issues.length&&t.issues.push(...kn(n,e.issues)),t.value[n]=e.value}const tr=_("$ZodArray",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{const o=n.value;if(!Array.isArray(o))return n.issues.push({expected:"array",code:"invalid_type",input:o,inst:e}),n;n.value=Array(o.length);const s=[];for(let i=0;i<o.length;i++){const a=o[i],u=t.element._zod.run({value:a,issues:[]},r);u instanceof Promise?s.push(u.then(l=>Be(l,n,i))):Be(u,n,i)}return s.length?Promise.all(s).then(()=>n):n}});function We(e,t,n,r){for(const s of e)if(s.issues.length===0)return t.value=s.value,t;const o=e.filter(s=>!G(s));return o.length===1?(t.value=o[0].value,o[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(s=>s.issues.map(i=>V(i,r,U())))}),t)}const nr=_("$ZodUnion",(e,t)=>{L.init(e,t),E(e._zod,"optin",()=>t.options.some(o=>o._zod.optin==="optional")?"optional":void 0),E(e._zod,"optout",()=>t.options.some(o=>o._zod.optout==="optional")?"optional":void 0),E(e._zod,"values",()=>{if(t.options.every(o=>o._zod.values))return new Set(t.options.flatMap(o=>Array.from(o._zod.values)))}),E(e._zod,"pattern",()=>{if(t.options.every(o=>o._zod.pattern)){const o=t.options.map(s=>s._zod.pattern);return new RegExp(`^(${o.map(s=>Ne(s.source)).join("|")})$`)}});const n=t.options.length===1,r=t.options[0]._zod.run;e._zod.parse=(o,s)=>{if(n)return r(o,s);let i=!1;const a=[];for(const u of t.options){const l=u._zod.run({value:o.value,issues:[]},s);if(l instanceof Promise)a.push(l),i=!0;else{if(l.issues.length===0)return l;a.push(l)}}return i?Promise.all(a).then(u=>We(u,o,e,s)):We(a,o,e,s)}}),rr=_("$ZodIntersection",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{const o=n.value,s=t.left._zod.run({value:o,issues:[]},r),i=t.right._zod.run({value:o,issues:[]},r);return s instanceof Promise||i instanceof Promise?Promise.all([s,i]).then(([u,l])=>Je(n,u,l)):Je(n,s,i)}});function Ee(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(we(e)&&we(t)){const n=Object.keys(t),r=Object.keys(e).filter(s=>n.indexOf(s)!==-1),o={...e,...t};for(const s of r){const i=Ee(e[s],t[s]);if(!i.valid)return{valid:!1,mergeErrorPath:[s,...i.mergeErrorPath]};o[s]=i.data}return{valid:!0,data:o}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<e.length;r++){const o=e[r],s=t[r],i=Ee(o,s);if(!i.valid)return{valid:!1,mergeErrorPath:[r,...i.mergeErrorPath]};n.push(i.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function Je(e,t,n){if(t.issues.length&&e.issues.push(...t.issues),n.issues.length&&e.issues.push(...n.issues),G(e))return e;const r=Ee(t.value,n.value);if(!r.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return e.value=r.data,e}const or=_("$ZodTransform",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new dt(e.constructor.name);const o=t.transform(n.value,n);if(r.async)return(o instanceof Promise?o:Promise.resolve(o)).then(i=>(n.value=i,n));if(o instanceof Promise)throw new q;return n.value=o,n}});function He(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const sr=_("$ZodOptional",(e,t)=>{L.init(e,t),e._zod.optin="optional",e._zod.optout="optional",E(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),E(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Ne(n.source)})?$`):void 0}),e._zod.parse=(n,r)=>{if(t.innerType._zod.optin==="optional"){const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>He(s,n.value)):He(o,n.value)}return n.value===void 0?n:t.innerType._zod.run(n,r)}}),ir=_("$ZodNullable",(e,t)=>{L.init(e,t),E(e._zod,"optin",()=>t.innerType._zod.optin),E(e._zod,"optout",()=>t.innerType._zod.optout),E(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Ne(n.source)}|null)$`):void 0}),E(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(n,r)=>n.value===null?n:t.innerType._zod.run(n,r)}),ar=_("$ZodDefault",(e,t)=>{L.init(e,t),e._zod.optin="optional",E(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);if(n.value===void 0)return n.value=t.defaultValue,n;const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>Ke(s,t)):Ke(o,t)}});function Ke(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const ur=_("$ZodPrefault",(e,t)=>{L.init(e,t),e._zod.optin="optional",E(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>(r.direction==="backward"||n.value===void 0&&(n.value=t.defaultValue),t.innerType._zod.run(n,r))}),cr=_("$ZodNonOptional",(e,t)=>{L.init(e,t),E(e._zod,"values",()=>{const n=t.innerType._zod.values;return n?new Set([...n].filter(r=>r!==void 0)):void 0}),e._zod.parse=(n,r)=>{const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>Ge(s,e)):Ge(o,e)}});function Ge(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const lr=_("$ZodCatch",(e,t)=>{L.init(e,t),E(e._zod,"optin",()=>t.innerType._zod.optin),E(e._zod,"optout",()=>t.innerType._zod.optout),E(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>(n.value=s.value,s.issues.length&&(n.value=t.catchValue({...n,error:{issues:s.issues.map(i=>V(i,r,U()))},input:n.value}),n.issues=[]),n)):(n.value=o.value,o.issues.length&&(n.value=t.catchValue({...n,error:{issues:o.issues.map(s=>V(s,r,U()))},input:n.value}),n.issues=[]),n)}}),fr=_("$ZodPipe",(e,t)=>{L.init(e,t),E(e._zod,"values",()=>t.in._zod.values),E(e._zod,"optin",()=>t.in._zod.optin),E(e._zod,"optout",()=>t.out._zod.optout),E(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(n,r)=>{if(r.direction==="backward"){const s=t.out._zod.run(n,r);return s instanceof Promise?s.then(i=>ie(i,t.in,r)):ie(s,t.in,r)}const o=t.in._zod.run(n,r);return o instanceof Promise?o.then(s=>ie(s,t.out,r)):ie(o,t.out,r)}});function ie(e,t,n){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},n)}const dr=_("$ZodReadonly",(e,t)=>{L.init(e,t),E(e._zod,"propValues",()=>t.innerType._zod.propValues),E(e._zod,"values",()=>t.innerType._zod.values),E(e._zod,"optin",()=>t.innerType?._zod?.optin),E(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(qe):qe(o)}});function qe(e){return e.value=Object.freeze(e.value),e}const hr=_("$ZodCustom",(e,t)=>{$.init(e,t),L.init(e,t),e._zod.parse=(n,r)=>n,e._zod.check=n=>{const r=n.value,o=t.fn(r);if(o instanceof Promise)return o.then(s=>Ye(s,n,r,e));Ye(o,n,r,e)}});function Ye(e,t,n,r){if(!e){const o={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(o.params=r._zod.def.params),t.issues.push(te(o))}}var Xe;class pr{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...n){const r=n[0];if(this._map.set(t,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,t)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const n=this._map.get(t);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(t),this}get(t){const n=t._zod.parent;if(n){const r={...this.get(n)??{}};delete r.id;const o={...r,...this._map.get(t)};return Object.keys(o).length?o:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function mr(){return new pr}(Xe=globalThis).__zod_globalRegistry??(Xe.__zod_globalRegistry=mr());const Q=globalThis.__zod_globalRegistry;function gr(e,t){return new e({type:"number",checks:[],...A(t)})}function yr(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...A(t)})}function Qe(e,t){return new vt({check:"less_than",...A(t),value:e,inclusive:!1})}function ye(e,t){return new vt({check:"less_than",...A(t),value:e,inclusive:!0})}function et(e,t){return new bt({check:"greater_than",...A(t),value:e,inclusive:!1})}function _e(e,t){return new bt({check:"greater_than",...A(t),value:e,inclusive:!0})}function tt(e,t){return new Hn({check:"multiple_of",...A(t),value:e})}function _r(e,t){return new Gn({check:"max_length",...A(t),maximum:e})}function nt(e,t){return new qn({check:"min_length",...A(t),minimum:e})}function vr(e,t){return new Yn({check:"length_equals",...A(t),length:e})}function br(e){return new Xn({check:"overwrite",tx:e})}function wr(e,t,n){return new e({type:"array",element:t,...A(n)})}function Er(e,t,n){return new e({type:"custom",check:"custom",fn:t,...A(n)})}function zr(e){const t=Tr(n=>(n.addIssue=r=>{if(typeof r=="string")n.issues.push(te(r,n.value,t._zod.def));else{const o=r;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=n.value),o.inst??(o.inst=t),o.continue??(o.continue=!t._zod.def.abort),n.issues.push(te(o))}},e(n.value,n)));return t}function Tr(e,t){const n=new $({check:"custom",...A(t)});return n._zod.check=e,n}function Et(e){let t=e?.target??"draft-2020-12";return t==="draft-4"&&(t="draft-04"),t==="draft-7"&&(t="draft-07"),{processors:e.processors??{},metadataRegistry:e?.metadata??Q,target:t,unrepresentable:e?.unrepresentable??"throw",override:e?.override??(()=>{}),io:e?.io??"output",counter:0,seen:new Map,cycles:e?.cycles??"ref",reused:e?.reused??"inline",external:e?.external??void 0}}function O(e,t,n={path:[],schemaPath:[]}){var r;const o=e._zod.def,s=t.seen.get(e);if(s)return s.count++,n.schemaPath.includes(e)&&(s.cycle=n.path),s.schema;const i={schema:{},count:1,cycle:void 0,path:n.path};t.seen.set(e,i);const a=e._zod.toJSONSchema?.();if(a)i.schema=a;else{const h={...n,schemaPath:[...n.schemaPath,e],path:n.path},g=e._zod.parent;if(g)i.ref=g,O(g,t,h),t.seen.get(g).isParent=!0;else if(e._zod.processJSONSchema)e._zod.processJSONSchema(t,i.schema,h);else{const y=i.schema,w=t.processors[o.type];if(!w)throw new Error(`[toJSONSchema]: Non-representable type encountered: ${o.type}`);w(e,t,y,h)}}const u=t.metadataRegistry.get(e);return u&&Object.assign(i.schema,u),t.io==="input"&&N(e)&&(delete i.schema.examples,delete i.schema.default),t.io==="input"&&i.schema._prefault&&((r=i.schema).default??(r.default=i.schema._prefault)),delete i.schema._prefault,t.seen.get(e).schema}function zt(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=s=>{const i=e.target==="draft-2020-12"?"$defs":"definitions";if(e.external){const h=e.external.registry.get(s[0])?.id,g=e.external.uri??(w=>w);if(h)return{ref:g(h)};const y=s[1].defId??s[1].schema.id??`schema${e.counter++}`;return s[1].defId=y,{defId:y,ref:`${g("__shared")}#/${i}/${y}`}}if(s[1]===n)return{ref:"#"};const u=`#/${i}/`,l=s[1].schema.id??`__schema${e.counter++}`;return{defId:l,ref:u+l}},o=s=>{if(s[1].schema.$ref)return;const i=s[1],{ref:a,defId:u}=r(s);i.def={...i.schema},u&&(i.defId=u);const l=i.schema;for(const h in l)delete l[h];l.$ref=a};if(e.cycles==="throw")for(const s of e.seen.entries()){const i=s[1];if(i.cycle)throw new Error(`Cycle detected: #/${i.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const s of e.seen.entries()){const i=s[1];if(t===s[0]){o(s);continue}if(e.external){const u=e.external.registry.get(s[0])?.id;if(t!==s[0]&&u){o(s);continue}}if(e.metadataRegistry.get(s[0])?.id){o(s);continue}if(i.cycle){o(s);continue}if(i.count>1&&e.reused==="ref"){o(s);continue}}}function Tt(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=i=>{const a=e.seen.get(i),u=a.def??a.schema,l={...u};if(a.ref===null)return;const h=a.ref;if(a.ref=null,h){r(h);const g=e.seen.get(h).schema;g.$ref&&(e.target==="draft-07"||e.target==="draft-04"||e.target==="openapi-3.0")?(u.allOf=u.allOf??[],u.allOf.push(g)):(Object.assign(u,g),Object.assign(u,l))}a.isParent||e.override({zodSchema:i,jsonSchema:u,path:a.path??[]})};for(const i of[...e.seen.entries()].reverse())r(i[0]);const o={};if(e.target==="draft-2020-12"?o.$schema="https://json-schema.org/draft/2020-12/schema":e.target==="draft-07"?o.$schema="http://json-schema.org/draft-07/schema#":e.target==="draft-04"?o.$schema="http://json-schema.org/draft-04/schema#":e.target,e.external?.uri){const i=e.external.registry.get(t)?.id;if(!i)throw new Error("Schema is missing an `id` property");o.$id=e.external.uri(i)}Object.assign(o,n.def??n.schema);const s=e.external?.defs??{};for(const i of e.seen.entries()){const a=i[1];a.def&&a.defId&&(s[a.defId]=a.def)}e.external||Object.keys(s).length>0&&(e.target==="draft-2020-12"?o.$defs=s:o.definitions=s);try{const i=JSON.parse(JSON.stringify(o));return Object.defineProperty(i,"~standard",{value:{...t["~standard"],jsonSchema:{input:le(t,"input"),output:le(t,"output")}},enumerable:!1,writable:!1}),i}catch{throw new Error("Error converting schema to JSON.")}}function N(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const r=e._zod.def;if(r.type==="transform")return!0;if(r.type==="array")return N(r.element,n);if(r.type==="set")return N(r.valueType,n);if(r.type==="lazy")return N(r.getter(),n);if(r.type==="promise"||r.type==="optional"||r.type==="nonoptional"||r.type==="nullable"||r.type==="readonly"||r.type==="default"||r.type==="prefault")return N(r.innerType,n);if(r.type==="intersection")return N(r.left,n)||N(r.right,n);if(r.type==="record"||r.type==="map")return N(r.keyType,n)||N(r.valueType,n);if(r.type==="pipe")return N(r.in,n)||N(r.out,n);if(r.type==="object"){for(const o in r.shape)if(N(r.shape[o],n))return!0;return!1}if(r.type==="union"){for(const o of r.options)if(N(o,n))return!0;return!1}if(r.type==="tuple"){for(const o of r.items)if(N(o,n))return!0;return!!(r.rest&&N(r.rest,n))}return!1}const Sr=(e,t={})=>n=>{const r=Et({...n,processors:t});return O(e,r),zt(r,e),Tt(r,e)},le=(e,t)=>n=>{const{libraryOptions:r,target:o}=n??{},s=Et({...r??{},target:o,io:t,processors:{}});return O(e,s),zt(s,e),Tt(s,e)},Nr=(e,t,n,r)=>{const o=n,{minimum:s,maximum:i,format:a,multipleOf:u,exclusiveMaximum:l,exclusiveMinimum:h}=e._zod.bag;typeof a=="string"&&a.includes("int")?o.type="integer":o.type="number",typeof h=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(o.minimum=h,o.exclusiveMinimum=!0):o.exclusiveMinimum=h),typeof s=="number"&&(o.minimum=s,typeof h=="number"&&t.target!=="draft-04"&&(h>=s?delete o.minimum:delete o.exclusiveMinimum)),typeof l=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(o.maximum=l,o.exclusiveMaximum=!0):o.exclusiveMaximum=l),typeof i=="number"&&(o.maximum=i,typeof l=="number"&&t.target!=="draft-04"&&(l<=i?delete o.maximum:delete o.exclusiveMaximum)),typeof u=="number"&&(o.multipleOf=u)},Pr=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema")},Or=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema")},Ar=(e,t,n,r)=>{const o=n,s=e._zod.def,{minimum:i,maximum:a}=e._zod.bag;typeof i=="number"&&(o.minItems=i),typeof a=="number"&&(o.maxItems=a),o.type="array",o.items=O(s.element,t,{...r,path:[...r.path,"items"]})},Lr=(e,t,n,r)=>{const o=e._zod.def,s=o.inclusive===!1,i=o.options.map((a,u)=>O(a,t,{...r,path:[...r.path,s?"oneOf":"anyOf",u]}));s?n.oneOf=i:n.anyOf=i},Ir=(e,t,n,r)=>{const o=e._zod.def,s=O(o.left,t,{...r,path:[...r.path,"allOf",0]}),i=O(o.right,t,{...r,path:[...r.path,"allOf",1]}),a=l=>"allOf"in l&&Object.keys(l).length===1,u=[...a(s)?s.allOf:[s],...a(i)?i.allOf:[i]];n.allOf=u},kr=(e,t,n,r)=>{const o=e._zod.def,s=O(o.innerType,t,r),i=t.seen.get(e);t.target==="openapi-3.0"?(i.ref=o.innerType,n.nullable=!0):n.anyOf=[s,{type:"null"}]},Rr=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType},Cr=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,n.default=JSON.parse(JSON.stringify(o.defaultValue))},Mr=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,t.io==="input"&&(n._prefault=JSON.parse(JSON.stringify(o.defaultValue)))},$r=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType;let i;try{i=o.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}n.default=i},Dr=(e,t,n,r)=>{const o=e._zod.def,s=t.io==="input"?o.in._zod.def.type==="transform"?o.out:o.in:o.out;O(s,t,r);const i=t.seen.get(e);i.ref=s},xr=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,n.readOnly=!0},Fr=(e,t,n,r)=>{const o=e._zod.def;O(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType},jr=(e,t)=>{gt.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:n=>Cn(e,n)},flatten:{value:n=>Rn(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,be,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,be,2)}},isEmpty:{get(){return e.issues.length===0}}})},R=_("ZodError",jr,{Parent:Error}),Zr=Oe(R),Ur=Ae(R),Vr=he(R),Br=pe(R),Wr=Dn(R),Jr=xn(R),Hr=Fn(R),Kr=jn(R),Gr=Zn(R),qr=Un(R),Yr=Vn(R),Xr=Bn(R),I=_("ZodType",(e,t)=>(L.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:le(e,"input"),output:le(e,"output")}}),e.toJSONSchema=Sr(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone(An(t,{checks:[...t.checks??[],...n.map(r=>typeof r=="function"?{_zod:{check:r,def:{check:"custom"},onattach:[]}}:r)]})),e.clone=(n,r)=>Ln(e,n,r),e.brand=()=>e,e.register=((n,r)=>(n.add(e,r),e)),e.parse=(n,r)=>Zr(e,n,r,{callee:e.parse}),e.safeParse=(n,r)=>Vr(e,n,r),e.parseAsync=async(n,r)=>Ur(e,n,r,{callee:e.parseAsync}),e.safeParseAsync=async(n,r)=>Br(e,n,r),e.spa=e.safeParseAsync,e.encode=(n,r)=>Wr(e,n,r),e.decode=(n,r)=>Jr(e,n,r),e.encodeAsync=async(n,r)=>Hr(e,n,r),e.decodeAsync=async(n,r)=>Kr(e,n,r),e.safeEncode=(n,r)=>Gr(e,n,r),e.safeDecode=(n,r)=>qr(e,n,r),e.safeEncodeAsync=async(n,r)=>Yr(e,n,r),e.safeDecodeAsync=async(n,r)=>Xr(e,n,r),e.refine=(n,r)=>e.check(zo(n,r)),e.superRefine=n=>e.check(To(n)),e.overwrite=n=>e.check(br(n)),e.optional=()=>ot(e),e.nullable=()=>st(e),e.nullish=()=>ot(st(e)),e.nonoptional=n=>go(e,n),e.array=()=>to(e),e.or=n=>ro([e,n]),e.and=n=>so(e,n),e.transform=n=>it(e,ao(n)),e.default=n=>fo(e,n),e.prefault=n=>po(e,n),e.catch=n=>_o(e,n),e.pipe=n=>it(e,n),e.readonly=()=>wo(e),e.describe=n=>{const r=e.clone();return Q.add(r,{description:n}),r},Object.defineProperty(e,"description",{get(){return Q.get(e)?.description},configurable:!0}),e.meta=(...n)=>{if(n.length===0)return Q.get(e);const r=e.clone();return Q.add(r,n[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),St=_("ZodNumber",(e,t)=>{wt.init(e,t),I.init(e,t),e._zod.processJSONSchema=(r,o,s)=>Nr(e,r,o),e.gt=(r,o)=>e.check(et(r,o)),e.gte=(r,o)=>e.check(_e(r,o)),e.min=(r,o)=>e.check(_e(r,o)),e.lt=(r,o)=>e.check(Qe(r,o)),e.lte=(r,o)=>e.check(ye(r,o)),e.max=(r,o)=>e.check(ye(r,o)),e.int=r=>e.check(rt(r)),e.safe=r=>e.check(rt(r)),e.positive=r=>e.check(et(0,r)),e.nonnegative=r=>e.check(_e(0,r)),e.negative=r=>e.check(Qe(0,r)),e.nonpositive=r=>e.check(ye(0,r)),e.multipleOf=(r,o)=>e.check(tt(r,o)),e.step=(r,o)=>e.check(tt(r,o)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function Nt(e){return gr(St,e)}const Qr=_("ZodNumberFormat",(e,t)=>{er.init(e,t),St.init(e,t)});function rt(e){return yr(Qr,e)}const eo=_("ZodArray",(e,t)=>{tr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Ar(e,n,r,o),e.element=t.element,e.min=(n,r)=>e.check(nt(n,r)),e.nonempty=n=>e.check(nt(1,n)),e.max=(n,r)=>e.check(_r(n,r)),e.length=(n,r)=>e.check(vr(n,r)),e.unwrap=()=>e.element});function to(e,t){return wr(eo,e,t)}const no=_("ZodUnion",(e,t)=>{nr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Lr(e,n,r,o),e.options=t.options});function ro(e,t){return new no({type:"union",options:e,...A(t)})}const oo=_("ZodIntersection",(e,t)=>{rr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Ir(e,n,r,o)});function so(e,t){return new oo({type:"intersection",left:e,right:t})}const io=_("ZodTransform",(e,t)=>{or.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Or(e,n),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new dt(e.constructor.name);n.addIssue=s=>{if(typeof s=="string")n.issues.push(te(s,n.value,t));else{const i=s;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=e),n.issues.push(te(i))}};const o=t.transform(n.value,n);return o instanceof Promise?o.then(s=>(n.value=s,n)):(n.value=o,n)}});function ao(e){return new io({type:"transform",transform:e})}const uo=_("ZodOptional",(e,t)=>{sr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Fr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function ot(e){return new uo({type:"optional",innerType:e})}const co=_("ZodNullable",(e,t)=>{ir.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>kr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function st(e){return new co({type:"nullable",innerType:e})}const lo=_("ZodDefault",(e,t)=>{ar.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Cr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function fo(e,t){return new lo({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():pt(t)}})}const ho=_("ZodPrefault",(e,t)=>{ur.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Mr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function po(e,t){return new ho({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():pt(t)}})}const mo=_("ZodNonOptional",(e,t)=>{cr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Rr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function go(e,t){return new mo({type:"nonoptional",innerType:e,...A(t)})}const yo=_("ZodCatch",(e,t)=>{lr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>$r(e,n,r,o),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function _o(e,t){return new yo({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const vo=_("ZodPipe",(e,t)=>{fr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Dr(e,n,r,o),e.in=t.in,e.out=t.out});function it(e,t){return new vo({type:"pipe",in:e,out:t})}const bo=_("ZodReadonly",(e,t)=>{dr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>xr(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function wo(e){return new bo({type:"readonly",innerType:e})}const Eo=_("ZodCustom",(e,t)=>{hr.init(e,t),I.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Pr(e,n)});function zo(e,t={}){return Er(Eo,e,t)}function To(e){return zr(e)}const So=Nt().int().positive(),No=Nt().int(),ae=(e,t,n,...r)=>{if(e)try{e.emit(n,...r)}catch(o){t.error("Repository event emission failed",{eventName:n,error:P(o),args:P(r)})}};function Po(e){return e.ok?e:{ok:!1,origin:"fetcher",kind:e.kind,code:e.code,message:e.error,...e.status!==void 0&&{status:e.status},details:e.details}}const ve={offset:0,limit:10},Oo=.5;class Ao{events;#e;#n;#t;#o;#s={...ve};#r=null;constructor({store:t,apiClient:n,repositoryConfig:r={}}){const{logger:o,logLevel:s,enableEvents:i}=r;if(o)this.#e=o,this.#n=s??"info",s!==void 0&&"level"in o&&(o.level=s);else{const a=s??"info";this.#e=new Z(a),this.#n=a}i===!0&&(this.events=new En.EventEmitter,this.events.setMaxListeners(0)),this.#e.info("ProtopediaInMemoryRepository constructor called",{repositoryConfig:P(r),storeConfig:t.getConfig(),eventsEnabled:i===!0}),this.#t=t,this.#o=n}async fetchAndNormalize(t){const n={...ve,...t};try{const r=await this.#o.fetchPrototypes(n);return r.ok&&this.#e.debug("Fetch operation completed",{count:r.data.length,params:n}),r}catch(r){return this.#e.error("Unexpected exception from API client",{error:P(r),params:n}),{ok:!1,origin:"fetcher",kind:"unknown",code:"UNKNOWN",error:r instanceof Error?r.message:String(r),details:{req:{method:"GET"}}}}}storeSnapshot(t){try{this.#t.setAll(t);const n=this.#t.getStats();return this.#e.debug("Store operation completed",{size:n.size,dataSizeBytes:n.dataSizeBytes}),{ok:!0,stats:n}}catch(n){return n instanceof Te?(this.#e.warn("Snapshot storage failed: data size exceeded",{dataSizeBytes:n.dataSizeBytes,maxDataSizeBytes:n.maxDataSizeBytes,dataState:n.dataState}),{ok:!1,origin:"store",kind:"storage_limit",code:"STORE_CAPACITY_EXCEEDED",message:`Data size ${n.dataSizeBytes} bytes exceeds maximum ${n.maxDataSizeBytes} bytes`,dataState:n.dataState}):n instanceof ee?(this.#e.error("Snapshot storage failed: size estimation error",{dataState:n.dataState,cause:P(n.cause)}),{ok:!1,origin:"store",kind:"serialization",code:"STORE_SERIALIZATION_FAILED",message:"Failed to estimate data size during serialization",dataState:n.dataState,cause:P(n.cause)}):(this.#e.error("Snapshot storage failed: unexpected error",{error:P(n)}),{ok:!1,origin:"store",kind:"unknown",code:"STORE_UNKNOWN",message:n instanceof Error?n.message:String(n),dataState:"UNKNOWN",cause:P(n)})}}getConfig(){return this.#t.getConfig()}getStats(){return this.#t.getStats()}async fetchAndStore(t,n){return this.#i(async()=>{const r=await this.fetchAndNormalize(t),o=Po(r);if(!o.ok)return o;if(!("data"in o))throw new Error("Unexpected: success result missing data field");const s=this.storeSnapshot(o.data);return s.ok&&n&&(this.#s={...ve,...t}),s})}async setupSnapshot(t){return ae(this.events,this.#e,"snapshotStarted","setup"),this.fetchAndStore(t,!0)}async refreshSnapshot(){return ae(this.events,this.#e,"snapshotStarted","refresh"),this.fetchAndStore(this.#s,!1)}async#i(t){if(this.#r)return this.#r;this.#r=t();try{const n=await this.#r;return n.ok?ae(this.events,this.#e,"snapshotCompleted",n.stats):ae(this.events,this.#e,"snapshotFailed",n),n}finally{this.#r=null}}async getPrototypeFromSnapshotByPrototypeId(t){const n=So.safeParse(t);if(!n.success)throw new Ze("Invalid prototype ID: must be a positive integer","prototypeId",{cause:n.error});return this.#t.getByPrototypeId(t)}async getRandomPrototypeFromSnapshot(){if(this.#t.size===0)return null;const t=this.#t.getAll(),n=Math.floor(Math.random()*t.length);return t[n]??null}async getRandomSampleFromSnapshot(t){const n=No.safeParse(t);if(!n.success)throw new Ze("Invalid sample size: must be an integer","size",{cause:n.error});if(t<=0||this.#t.size===0)return[];const r=this.#t.getAll(),o=Math.min(t,r.length);if(o>r.length*Oo){const a=[...r];for(let u=a.length-1;u>0;u--){const l=Math.floor(Math.random()*(u+1));[a[u],a[l]]=[a[l],a[u]]}return a.slice(0,o)}const s=[],i=new Set;for(;s.length<o;){const a=Math.floor(Math.random()*r.length);i.has(a)||(i.add(a),s.push(r[a]))}return s}async getPrototypeIdsFromSnapshot(){return this.#t.getPrototypeIds()}async getAllFromSnapshot(){return this.#t.getAll()}analyzePrototypesWithForLoop(t){if(t.length===0)return{min:null,max:null};let n=t[0].id,r=t[0].id;for(let o=1;o<t.length;o++){const s=t[o].id;s<n&&(n=s),s>r&&(r=s)}return{min:n,max:r}}async analyzePrototypes(){const t=this.#t.getAll();return this.analyzePrototypesWithForLoop(t)}dispose(){this.events?.removeAllListeners()}}class Lo{#e={};#n={};#t={};setStoreConfig(t){return this.#e=ue(this.#e,t),this}setApiClientConfig(t){return this.#n=ue(this.#n,t),this}setRepositoryConfig(t){return this.#t=ue(this.#t,t),this}build(){const t={...this.#e,logger:this.#e.logger??new Z(this.#e.logLevel??"info")},n={...this.#n,logger:this.#n.logger??new Z(this.#n.logLevel??"info")},r=this.#t.logger??new Z(this.#t.logLevel??"info"),o={...this.#t,logger:r},s=this.buildStore(t,r),i=this.buildApiClient(n,r);try{return new Ao({store:s,apiClient:i,repositoryConfig:o})}catch(a){throw typeof r.error=="function"&&r.error("Failed to create ProtopediaInMemoryRepositoryImpl",P({error:a})),a}}buildStore(t,n){try{return new Nn(t)}catch(r){if(typeof n.error=="function"){let o;r instanceof de?(o={error:r,dataState:r.dataState},r instanceof Te?(o.dataSizeBytes=r.dataSizeBytes,o.maxDataSizeBytes=r.maxDataSizeBytes):r instanceof ee&&(o.cause=r.cause)):o={error:r},n.error("Failed to create PrototypeInMemoryStore",P(o))}throw r}}buildApiClient(t,n){try{return new bn(t)}catch(r){throw typeof n.error=="function"&&n.error("Failed to create ProtopediaApiCustomClient",P({error:r})),r}}}function Io(e){const t=new Lo,n=e.logLevel??"info",r=new Z(n),o={ttlMs:1800*1e3,maxDataSizeBytes:ce,logger:r};t.setStoreConfig(o);const s={protoPediaApiClientOptions:{token:e.protopediaApiToken,timeoutMs:90*1e3,userAgent:`PromidasForLocal/${lt}`,logger:r,logLevel:n},logger:r,progressLog:!0};t.setApiClientConfig(s);const i={logger:r};return t.setRepositoryConfig(i),t.build()}export{zn as C,Te as D,ee as S,de as a,Io as c,En as e};
